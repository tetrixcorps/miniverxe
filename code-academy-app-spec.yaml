name: code-academy-production
region: fra

services:
  - name: code-academy-frontend
    github:
      repo: tetrixcorps/miniverxe
      branch: main
      deploy_on_push: true
    source_dir: /code-academy-frontend
    http_port: 3000
    instance_count: 1
    instance_size_slug: basic-xxs
    build_command: |
      # Clean up any conflicting lockfiles
      rm -f package-lock.json yarn.lock npm-shrinkwrap.json .yarnrc .yarnrc.yml
      # Install dependencies (pnpm already installed by buildpack)
      pnpm install --frozen-lockfile
      # Build the Code Academy application
      pnpm run build:code-academy
    run_command: pnpm run start:code-academy
    envs:
      - key: NODE_ENV
        value: production
        scope: RUN_AND_BUILD_TIME
      - key: HOST
        value: 0.0.0.0
        scope: RUN_AND_BUILD_TIME
      - key: PORT
        value: "3000"
        scope: RUN_AND_BUILD_TIME
      - key: TETRIX_API_URL
        value: "https://tetrixcorp.com/api"
        scope: RUN_AND_BUILD_TIME
      - key: TETRIX_2FA_API_URL
        value: "https://tetrixcorp.com/api/v2/2fa"
        scope: RUN_AND_BUILD_TIME
      - key: CROSS_PLATFORM_SESSION_SECRET
        value: "tetrix-code-academy-session-secret-2024"
        scope: RUN_AND_BUILD_TIME
      - key: NEXT_PUBLIC_TETRIX_API_URL
        value: "https://tetrixcorp.com/api"
        scope: RUN_AND_BUILD_TIME
      - key: NEXT_PUBLIC_TETRIX_2FA_API_URL
        value: "https://tetrixcorp.com/api/v2/2fa"
        scope: RUN_AND_BUILD_TIME
    health_check:
      http_path: /api/health
      initial_delay_seconds: 60
      period_seconds: 15
      timeout_seconds: 10
      success_threshold: 1
      failure_threshold: 5

  - name: code-academy-backend
    github:
      repo: tetrixcorps/miniverxe
      branch: main
      deploy_on_push: true
    source_dir: /code-academy-backend
    http_port: 3001
    instance_count: 1
    instance_size_slug: basic-xxs
    build_command: |
      npm install
      npx prisma generate
      npx prisma db push
    run_command: npm run start
    envs:
      - key: NODE_ENV
        value: production
        scope: RUN_AND_BUILD_TIME
      - key: PORT
        value: "3001"
        scope: RUN_AND_BUILD_TIME
      - key: DATABASE_URL
        value: "postgresql://tetrix_user:tetrix_password@tetrix-postgres-do-user-12345678-0.db.ondigitalocean.com:25060/tetrix_code_academy?sslmode=require"
        scope: RUN_AND_BUILD_TIME
      - key: TETRIX_2FA_API_URL
        value: "https://tetrixcorp.com/api/v2/2fa"
        scope: RUN_AND_BUILD_TIME
      - key: TETRIX_2FA_API_KEY
        value: "tetrix-2fa-api-key"
        scope: RUN_AND_BUILD_TIME
      - key: CORS_ORIGIN
        value: "https://poisonedreligion.ai,https://tetrixcorp.com"
        scope: RUN_AND_BUILD_TIME
    health_check:
      http_path: /api/health
      initial_delay_seconds: 30
      period_seconds: 15
      timeout_seconds: 10
      success_threshold: 1
      failure_threshold: 3

domains:
  - domain: poisonedreligion.ai
    type: PRIMARY
  - domain: www.poisonedreligion.ai
    type: ALIAS

ingress:
  rules:
    - match:
        path:
          prefix: /
      component:
        name: code-academy-frontend
    - match:
        path:
          prefix: /api
      component:
        name: code-academy-backend

alerts:
  - rule: DEPLOYMENT_FAILED
  - rule: DOMAIN_FAILED

features:
  - buildpack-stack=ubuntu-22
