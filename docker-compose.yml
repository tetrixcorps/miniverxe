# docker-compose.yml (corrected for Compose v2+)

services:
  api:
    build: ./services/api
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/secrets/fb-admin.json
      - FIRESTORE_EMULATOR_HOST=firebase-emulator:8080
      - AUTH_EMULATOR_HOST=firebase-emulator:9099
      - COINBASE_API_KEY=${COINBASE_API_KEY}
      - DATABASE_URL=postgresql://diegomartinez:password@postgres:5432/diegomartinez
    volumes:
      - ./secrets/fb-admin.json:/secrets/fb-admin.json:ro
    ports: [ "4000:4000" ]
    depends_on: [firebase-emulator, labelstudio, postgres]

  web:
    build: ./apps/web
    environment:
      - VITE_API_URL=http://localhost:4000
    ports: ["5173:4173"]

  # Firebase Emulator (Firestore + Auth)
  firebase-emulator:
    image: node:18
    working_dir: /workspace
    volumes:
      - ./:/workspace
    command: >
      sh -c "npm install -g firebase-tools && firebase emulators:start --only firestore,auth --project demo-project"
    ports:
      - "8080:8080"   # Firestore
      - "9099:9099"   # Auth
      - "4000:4000"   # Emulator UI

  # Label Studio
  labelstudio:
    image: heartexlabs/label-studio:latest
    ports:
      - "8081:8080"
    volumes:
      - ./data/ls:/label-studio/data

  # Postgres for local development
  postgres:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_USER: diegomartinez
      POSTGRES_PASSWORD: NewSecurePassword123
      POSTGRES_DB: diegomartinez
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  ollama:
    image: ollama/ollama:latest
    restart: always
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    environment:
      - OLLAMA_MODELS=/root/.ollama/models

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    restart: always
    ports:
      - "3000:8080"
    volumes:
      - open-webui-data:/app/backend/data
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - OPENAI_API_BASE=http://host.docker.internal:4000/llm

# wallet-svc:
#   build: ./services/wallet
#   environment:
#     - COINBASE_API_KEY=${COINBASE_API_KEY}
#   ports: ["4100:4100"]

volumes:
  postgres_data:
  open-webui-data:
  ollama-data: 