---
// TETRIX Unified Authentication Modal
// Phone-based authentication using Telnyx Verify API
// No email/password - only phone number + OTP verification
---

<div id="unified-auth-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 pointer-events-auto transition-opacity duration-300" role="dialog" aria-modal="true" tabindex="-1">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[85vh] overflow-y-auto">
      
      <!-- Modal Header -->
      <div class="bg-gradient-to-r from-brand-red to-brand-orange p-4 rounded-t-xl">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-xl font-bold text-white" id="auth-modal-title">TETRIX Login</h2>
            <p class="text-white/80 text-xs mt-1" id="auth-modal-subtitle">Secure phone verification</p>
          </div>
          <button id="close-auth-modal" class="text-white hover:text-white/80 transition-colors p-1 rounded hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/50" aria-label="Close modal" type="button">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        
        <!-- Compact Progress Indicator -->
        <div class="mt-3">
          <div class="flex items-center justify-center space-x-1.5" id="progress-indicators">
            <div id="step-indicator-1" class="w-2 h-2 rounded-full bg-white/40 transition-all duration-300"></div>
            <div id="step-indicator-2" class="w-2 h-2 rounded-full bg-white/40 transition-all duration-300 hidden"></div>
            <div id="step-indicator-3" class="w-2 h-2 rounded-full bg-white/40 transition-all duration-300"></div>
            <div id="step-indicator-4" class="w-2 h-2 rounded-full bg-white/40 transition-all duration-300 hidden"></div>
          </div>
          <p class="text-white/70 text-xs text-center mt-1.5" id="step-description">Step 1 of 3</p>
        </div>
      </div>

      <!-- Modal Content -->
      <div class="p-5">
        
        <!-- Step 1: Phone Number Input (NEW/USER CHECK) -->
        <div id="auth-step-1" class="space-y-4">
          <div class="text-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Enter Your Phone Number</h3>
            <p class="text-gray-500 text-xs mt-1">We'll send you a verification code</p>
          </div>

          <form id="unified-phone-form" class="space-y-3" onsubmit="event.preventDefault(); return false;">
            <div>
              <!-- Country Code Select -->
              <label for="country-code" class="sr-only">Country</label>
              <select id="country-code" name="countryCode" autocomplete="country" 
                      class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-red focus:border-transparent text-gray-900 bg-white hover:bg-gray-50 transition-colors">
                <option value="">Select Your Country</option>
              </select>
            </div>
            
            <div>
              <!-- Phone Number Input - MINIMAL: No JavaScript interference during typing -->
              <label for="unified-auth-phone-number" class="sr-only">Phone Number</label>
              <input 
                type="tel" 
                id="unified-auth-phone-number" 
                name="phoneNumber" 
                required autocomplete="tel-national"
                class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-red focus:border-transparent text-gray-900 bg-white"
                     placeholder="1234567890"
                     inputmode="numeric"
                autocomplete="tel-national"
                maxlength="15"
                style="color: #111827 !important; background-color: #ffffff !important; opacity: 1 !important; -webkit-text-fill-color: #111827 !important; caret-color: #111827 !important;">
              <p class="text-xs text-gray-400 mt-1">Enter numbers only (7-15 digits, cleaned on blur)</p>
            </div>

            <button type="button" id="check-user-btn" class="w-full py-2.5 bg-brand-red text-white rounded-lg hover:bg-red-700 transition-colors font-medium text-sm">
              Continue
            </button>
          </form>
        </div>

        <!-- Step 2: Industry Selection (NEW USERS ONLY) -->
        <div id="auth-step-2" class="space-y-4 hidden relative z-20" style="pointer-events: auto;">
          <div class="text-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Your Organization</h3>
            <p class="text-gray-500 text-xs mt-1">We need a few details to set up your account</p>
          </div>

          <div class="space-y-3">
            <!-- Name Fields (First Name, Last Name) -->
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label for="first-name-input" class="block text-xs font-medium text-gray-700 mb-1.5">First Name *</label>
                <input type="text" id="first-name-input" name="firstName" required autocomplete="given-name"
                       class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-red focus:border-transparent"
                       placeholder="Enter your first name" 
                       style="pointer-events: auto !important;"
                       inputmode="text">
              </div>
              <div>
                <label for="last-name-input" class="block text-xs font-medium text-gray-700 mb-1.5">Last Name *</label>
                <input type="text" id="last-name-input" name="lastName" required autocomplete="family-name"
                       class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-red focus:border-transparent"
                       placeholder="Enter your last name"
                       style="pointer-events: auto !important;"
                       inputmode="text">
              </div>
            </div>

            <div>
              <label for="industry-select" class="block text-xs font-medium text-gray-700 mb-1.5">Industry *</label>
              <select id="industry-select" name="industry" required autocomplete="organization" 
                      class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-red focus:border-transparent">
                <option value="">Choose your industry...</option>
                <option value="healthcare">üè• Healthcare</option>
                <option value="construction">üèóÔ∏è Construction</option>
                <option value="logistics">üöõ Logistics & Fleet</option>
                <option value="government">üèõÔ∏è Government</option>
                <option value="education">üéì Education</option>
                <option value="retail">üõí Retail</option>
                <option value="hospitality">üè® Hospitality</option>
                <option value="wellness">üí™ Wellness</option>
                <option value="beauty">üíÑ Beauty</option>
                <option value="legal">‚öñÔ∏è Legal</option>
                <option value="marketing">üì¢ Marketing</option>
              </select>
            </div>

            <div>
              <label for="role-select" class="block text-xs font-medium text-gray-700 mb-1.5">
                Role *
                <span id="role-status" class="text-xs text-gray-400 ml-1">(Select industry first)</span>
              </label>
              <select id="role-select" name="role" required disabled autocomplete="organization-title"
                      class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-red focus:border-transparent transition-all duration-300">
                <option value="">Choose your role...</option>
              </select>
            </div>

            <div>
              <label for="unified-organization-input" class="block text-xs font-medium text-gray-700 mb-1.5">Organization *</label>
              <input type="text" id="unified-organization-input" name="organization" required autocomplete="organization"
                     class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-red focus:border-transparent"
                     placeholder="Enter your organization name">
            </div>
          </div>

          <div class="flex space-x-3 pt-2">
            <button type="button" id="back-to-phone" class="flex-1 py-2.5 text-sm border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
              Back
            </button>
            <button type="button" id="continue-to-otp" class="flex-1 py-2.5 text-sm bg-brand-red text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-medium" style="pointer-events: auto !important; cursor: pointer !important;">
              Continue
            </button>
          </div>
        </div>

        <!-- Step 3: Send Verification Code -->
        <div id="auth-step-3" class="space-y-6 hidden">
          <div class="text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
              </svg>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Verify Your Phone Number</h3>
            <p class="text-gray-600 text-sm">We'll send a code to <span id="display-phone-number" class="font-medium"></span></p>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <button type="button" id="send-sms-btn" class="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                üì± SMS
              </button>
              <button type="button" id="send-call-btn" class="px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium">
                üìû Voice
              </button>
              <button type="button" id="send-whatsapp-btn" class="px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm font-medium">
                üí¨ WhatsApp
              </button>
              <button type="button" id="send-flashcall-btn" class="px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm font-medium">
                ‚ö° Flash Call
              </button>
            </div>

          <div class="flex space-x-4">
            <button type="button" id="back-to-industry" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors hidden" hidden>
              Back
            </button>
            <button type="button" id="change-phone" class="flex-1 px-4 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
              Change Phone Number
            </button>
          </div>
        </div>

        <!-- Step 4: OTP Verification -->
        <div id="auth-step-4" class="space-y-6 hidden">
          <div class="text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Enter Verification Code</h3>
            <p class="text-gray-600 text-sm">We sent a code to <span id="display-phone-number-otp" class="font-medium"></span></p>
          </div>

          <form id="otp-form" class="space-y-4">
            <div>
              <label for="unified-verification-code" class="block text-sm font-medium text-gray-700 mb-2">Verification Code *</label>
              <input type="text" id="unified-verification-code" name="verificationCode" required maxlength="5" autocomplete="one-time-code" inputmode="numeric" pattern="[0-9]*"
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-red focus:border-transparent text-center text-lg font-medium tracking-widest"
                     placeholder="Enter 5-digit code"
                     style="color: #111827 !important; background-color: #ffffff !important; opacity: 1 !important; -webkit-text-fill-color: #111827 !important; caret-color: #111827 !important;">
            </div>

            <button type="button" id="unified-verify-code-btn" class="w-full px-4 py-3 bg-brand-red text-white rounded-lg hover:bg-red-700 transition-colors">
              Verify Code
            </button>

            <div class="text-center">
              <button type="button" id="resend-code-btn" class="text-sm text-brand-red hover:underline">
                Resend Code
              </button>
            </div>

            <!-- Resend Timer -->
            <div id="resend-timer" class="text-center text-sm text-gray-500 mt-2 hidden">
              Resend code in <span id="countdown">60</span>s
            </div>
          </form>

          <div class="flex space-x-4">
            <button type="button" id="back-to-phone-verification" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
              Back
            </button>
            <button type="button" id="change-phone-number" class="flex-1 px-4 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
              Change Phone
            </button>
          </div>
        </div>

        <!-- Error Messages -->
        <div id="auth-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mt-4">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-red-800">Error</h3>
              <p class="text-sm text-red-700 mt-1" id="auth-error-message">Something went wrong.</p>
            </div>
          </div>
        </div>

        <!-- Success Messages -->
        <div id="auth-success" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mt-4">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-green-800">Success!</h3>
              <p class="text-sm text-green-700 mt-1" id="auth-success-message">Verification successful!</p>
            </div>
          </div>
        </div>

        <!-- Loading State -->
        <div id="auth-loading" class="hidden text-center py-4">
          <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-brand-red"></div>
          <p class="text-sm text-gray-600 mt-2">Processing...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- [DEV-HOTFIX] CRITICAL: Inline script executes IMMEDIATELY - before any module code -->
<script is:inline>
  (function() {
    'use strict';
    try {
      // Define changePhoneBtn getter FIRST - before ANY other code can reference it
      if (typeof window !== 'undefined') {
        if (!('changePhoneBtn' in window)) {
          Object.defineProperty(window, 'changePhoneBtn', {
            get: function() { 
              try { return document.getElementById('change-phone'); } 
              catch(e) { return null; }
            },
            configurable: true,
            enumerable: false
          });
          console.log('[DEV-HOTFIX-IMMEDIATE] changePhoneBtn getter defined');
        }
      }
      
      // Define showStep function
      if (typeof window.showStep !== 'function') {
        window.showStep = function(stepNum) {
          try {
            var ids = ['auth-step-1', 'auth-step-2', 'auth-step-3', 'auth-step-4'];
            for (var i = 0; i < ids.length; i++) {
              var el = document.getElementById(ids[i]);
              if (el) el.classList.toggle('hidden', i !== (stepNum - 1));
            }
          } catch(e) {
            console.error('[DEV-HOTFIX] showStep error:', e);
          }
        };
        console.log('[DEV-HOTFIX-IMMEDIATE] showStep function defined');
      }
      
      // Define JoRoMiIntegration class
      if (typeof window.JoRoMiIntegration === 'undefined') {
        window.JoRoMiIntegration = function JoRoMiIntegration() {
          this.isLocal = true;
          this.isDevelopment = true;
          this.joromiUrl = '/joromi';
          this.initializeEventListeners = function() {};
          this.redirectToJoRoMi = function() {};
          this.checkJoRoMiAvailability = function() { return Promise.resolve(true); };
          this.getJoRoMiUrl = function() { return '/joromi'; };
        };
        console.log('[DEV-HOTFIX-IMMEDIATE] JoRoMiIntegration class defined');
      }
    } catch(e) {
      console.error('[DEV-HOTFIX] Critical error defining globals:', e);
      if (typeof window !== 'undefined') {
        window.changePhoneBtn = null;
      }
    }
  })();
</script>

<script>
  // Industry-specific roles mapping
  const industryRoles = {
    healthcare: [
      { value: 'doctor', label: 'Doctor' },
      { value: 'nurse', label: 'Nurse' },
      { value: 'admin', label: 'Administrator' },
      { value: 'receptionist', label: 'Receptionist' }
    ],
    construction: [
      { value: 'project_manager', label: 'Project Manager' },
      { value: 'site_supervisor', label: 'Site Supervisor' },
      { value: 'safety_officer', label: 'Safety Officer' },
      { value: 'foreman', label: 'Foreman' }
    ],
    logistics: [
      { value: 'fleet_manager', label: 'Fleet Manager' },
      { value: 'dispatcher', label: 'Dispatcher' },
      { value: 'driver', label: 'Driver' },
      { value: 'operations', label: 'Operations Manager' }
    ],
    government: [
      { value: 'department_head', label: 'Department Head' },
      { value: 'citizen_services', label: 'Citizen Services' },
      { value: 'emergency_services', label: 'Emergency Services' },
      { value: 'permit_office', label: 'Permit Office' }
    ],
    education: [
      { value: 'principal', label: 'Principal' },
      { value: 'teacher', label: 'Teacher' },
      { value: 'admin', label: 'Administrator' },
      { value: 'parent', label: 'Parent' }
    ],
    retail: [
      { value: 'store_manager', label: 'Store Manager' },
      { value: 'sales_associate', label: 'Sales Associate' },
      { value: 'inventory', label: 'Inventory Manager' },
      { value: 'customer_service', label: 'Customer Service' }
    ],
    hospitality: [
      { value: 'general_manager', label: 'General Manager' },
      { value: 'front_desk', label: 'Front Desk' },
      { value: 'concierge', label: 'Concierge' },
      { value: 'guest_services', label: 'Guest Services' }
    ],
    wellness: [
      { value: 'facility_manager', label: 'Facility Manager' },
      { value: 'trainer', label: 'Trainer' },
      { value: 'nutritionist', label: 'Nutritionist' },
      { value: 'reception', label: 'Reception' }
    ],
    beauty: [
      { value: 'salon_manager', label: 'Salon Manager' },
      { value: 'stylist', label: 'Stylist' },
      { value: 'esthetician', label: 'Esthetician' },
      { value: 'reception', label: 'Reception' }
    ],
    legal: [
      { value: 'partner', label: 'Partner' },
      { value: 'associate', label: 'Associate' },
      { value: 'paralegal', label: 'Paralegal' },
      { value: 'admin', label: 'Administrator' }
    ],
    marketing: [
      { value: 'ad_creative', label: 'Ad Creative' },
      { value: 'campaign_manager', label: 'Campaign Manager' },
      { value: 'designer', label: 'Designer' },
      { value: 'analyst', label: 'Analyst' },
      { value: 'account_manager', label: 'Account Manager' }
    ]
  };

  // Industry dashboard mappings (from robust implementation)
  // Updated to route to consolidated dashboards with HubSpot/Salesforce integration
  const industryDashboards = {
    healthcare: '/dashboards/healthcare',
    construction: '/dashboards/construction-consolidated',
    logistics: '/dashboards/logistics-consolidated',
    government: '/dashboards/government',
    education: '/dashboards/education',
    retail: '/dashboards/retail-consolidated',
    hospitality: '/dashboards/hospitality',
    wellness: '/dashboards/wellness',
    beauty: '/dashboards/beauty',
    legal: '/dashboards/legal-consolidated',
    marketing: '/dashboards/marketing-consolidated'
  };

  // Load countries for phone validation - ENHANCED with 200+ countries support
  async function loadCountries() {
    console.log('üåç Loading countries...');
    try {
      const response = await fetch('/api/v2/auth/countries');
      const result = await response.json();
      console.log('‚úÖ Countries API response:', result);
      
      if (result.success && result.countries && result.countries.length > 0) {
        populateCountrySelect(result.countries);
        return;
      }
    } catch (error) {
      console.log('API countries fetch failed, using comprehensive fallback list', error);
    }
    
    // Comprehensive fallback: 60+ countries with proper calling codes
    const fallbackCountries = [
      { code: '+1', name: 'United States', callingCode: '+1' },
      { code: '+1', name: 'Canada', callingCode: '+1' },
      { code: '+44', name: 'United Kingdom', callingCode: '+44' },
      { code: '+61', name: 'Australia', callingCode: '+61' },
      { code: '+64', name: 'New Zealand', callingCode: '+64' },
      { code: '+27', name: 'South Africa', callingCode: '+27' },
      { code: '+971', name: 'UAE', callingCode: '+971' },
      { code: '+966', name: 'Saudi Arabia', callingCode: '+966' },
      { code: '+33', name: 'France', callingCode: '+33' },
      { code: '+49', name: 'Germany', callingCode: '+49' },
      { code: '+39', name: 'Italy', callingCode: '+39' },
      { code: '+34', name: 'Spain', callingCode: '+34' },
      { code: '+31', name: 'Netherlands', callingCode: '+31' },
      { code: '+32', name: 'Belgium', callingCode: '+32' },
      { code: '+41', name: 'Switzerland', callingCode: '+41' },
      { code: '+43', name: 'Austria', callingCode: '+43' },
      { code: '+45', name: 'Denmark', callingCode: '+45' },
      { code: '+46', name: 'Sweden', callingCode: '+46' },
      { code: '+47', name: 'Norway', callingCode: '+47' },
      { code: '+358', name: 'Finland', callingCode: '+358' },
      { code: '+48', name: 'Poland', callingCode: '+48' },
      { code: '+353', name: 'Ireland', callingCode: '+353' },
      { code: '+351', name: 'Portugal', callingCode: '+351' },
      { code: '+30', name: 'Greece', callingCode: '+30' },
      { code: '+90', name: 'Turkey', callingCode: '+90' },
      { code: '+7', name: 'Russia', callingCode: '+7' },
      { code: '+380', name: 'Ukraine', callingCode: '+380' },
      { code: '+86', name: 'China', callingCode: '+86' },
      { code: '+81', name: 'Japan', callingCode: '+81' },
      { code: '+82', name: 'South Korea', callingCode: '+82' },
      { code: '+886', name: 'Taiwan', callingCode: '+886' },
      { code: '+852', name: 'Hong Kong', callingCode: '+852' },
      { code: '+65', name: 'Singapore', callingCode: '+65' },
      { code: '+60', name: 'Malaysia', callingCode: '+60' },
      { code: '+66', name: 'Thailand', callingCode: '+66' },
      { code: '+62', name: 'Indonesia', callingCode: '+62' },
      { code: '+63', name: 'Philippines', callingCode: '+63' },
      { code: '+84', name: 'Vietnam', callingCode: '+84' },
      { code: '+91', name: 'India', callingCode: '+91' },
      { code: '+92', name: 'Pakistan', callingCode: '+92' },
      { code: '+880', name: 'Bangladesh', callingCode: '+880' },
      { code: '+52', name: 'Mexico', callingCode: '+52' },
      { code: '+55', name: 'Brazil', callingCode: '+55' },
      { code: '+54', name: 'Argentina', callingCode: '+54' },
      { code: '+56', name: 'Chile', callingCode: '+56' },
      { code: '+57', name: 'Colombia', callingCode: '+57' },
      { code: '+51', name: 'Peru', callingCode: '+51' },
      { code: '+58', name: 'Venezuela', callingCode: '+58' },
      { code: '+593', name: 'Ecuador üá™üá®', callingCode: '+593' },
      { code: '+598', name: 'Uruguay', callingCode: '+598' },
      { code: '+595', name: 'Paraguay', callingCode: '+595' },
      { code: '+591', name: 'Bolivia', callingCode: '+591' },
      { code: '+506', name: 'Costa Rica', callingCode: '+506' },
      { code: '+507', name: 'Panama', callingCode: '+507' },
      { code: '+502', name: 'Guatemala', callingCode: '+502' },
      { code: '+504', name: 'Honduras', callingCode: '+504' },
      { code: '+503', name: 'El Salvador', callingCode: '+503' },
      { code: '+505', name: 'Nicaragua', callingCode: '+505' },
      { code: '+1', name: 'Dominican Republic', callingCode: '+1' },
      { code: '+53', name: 'Cuba', callingCode: '+53' },
      { code: '+20', name: 'Egypt', callingCode: '+20' },
      { code: '+234', name: 'Nigeria', callingCode: '+234' },
      { code: '+254', name: 'Kenya', callingCode: '+254' },
      { code: '+233', name: 'Ghana', callingCode: '+233' },
      { code: '+972', name: 'Israel', callingCode: '+972' }
    ];
    
    populateCountrySelect(fallbackCountries);
  }

  function populateCountrySelect(countries: any[]) {
    console.log('üìù Populating country select with', countries.length, 'countries');
    const select = document.getElementById('country-code');
    if (select) {
      select.innerHTML = '<option value="">Select Your Country</option>';
      countries.forEach((country: any) => {
        const option = document.createElement('option');
        option.value = country.code || country.callingCode || '';
        // Make country names fully readable with proper spacing
        const countryName = country.name || country.countryName || '';
        const countryCode = country.code || country.callingCode || '';
        // Store both code and name for better display
        option.textContent = `${countryName} (${countryCode})`;
        select.appendChild(option);
      });
      console.log(`‚úÖ Loaded ${countries.length} countries into dropdown`);
    } else {
      console.error('‚ùå Country code select element not found');
    }
  }

  // Initialize Unified Auth Modal
  function initUnifiedAuthModal() {
    if ((window as any).__unifiedAuthInitialized) {
      console.log('[UnifiedAuth] Already initialized - skipping duplicate setup');
      return;
    }
    (window as any).__unifiedAuthInitialized = true;
    console.log('%c[UnifiedAuth] Initializing handlers', 'color:#ef4444;font-weight:bold');
    console.log('üîß Initializing Unified Auth Modal...');
    const modal = document.getElementById('unified-auth-modal');
    const closeBtn = document.getElementById('close-auth-modal');
    
    // Step elements
    const step1 = document.getElementById('auth-step-1');
    const step2 = document.getElementById('auth-step-2');
    const step3 = document.getElementById('auth-step-3');
    const step4 = document.getElementById('auth-step-4');
    
    // Load countries immediately on initialization
    console.log('üîß Calling loadCountries on initialization...');
    loadCountries();
    
    // Step indicators
    const stepIndicator1 = document.getElementById('step-indicator-1');
    const stepIndicator2 = document.getElementById('step-indicator-2');
    const stepIndicator3 = document.getElementById('step-indicator-3');
    const stepIndicator4 = document.getElementById('step-indicator-4');
    const stepDescription = document.getElementById('step-description');
    
    // New flow elements - CRITICAL: Scope to unified-auth-modal
    const checkUserBtn = modal?.querySelector('#check-user-btn') as HTMLButtonElement || document.getElementById('check-user-btn') as HTMLButtonElement;
    const phoneInputStep1 = modal?.querySelector('#unified-auth-phone-number') as HTMLInputElement || document.getElementById('unified-auth-phone-number') as HTMLInputElement;
    const countryCodeStep1 = modal?.querySelector('#country-code') as HTMLSelectElement || document.getElementById('country-code') as HTMLSelectElement;
    const continueToOtpBtn = modal?.querySelector('#continue-to-otp') as HTMLButtonElement || document.getElementById('continue-to-otp') as HTMLButtonElement;
    
    // Phone validation function using libphonenumber-js
    // Dynamically import libphonenumber-js for client-side validation
    let libphonenumber: any = null;
    
    async function loadLibPhoneNumber() {
      if (libphonenumber) return libphonenumber;
      
      try {
        // Dynamic import for client-side usage
        libphonenumber = await import('libphonenumber-js');
        console.log('‚úÖ libphonenumber-js loaded successfully');
        return libphonenumber;
      } catch (error) {
        console.error('‚ùå Failed to load libphonenumber-js:', error);
        return null;
      }
    }
    
    // Initialize libphonenumber on modal open
    loadLibPhoneNumber();
    
    function validatePhoneNumber(phoneNumber: string, countryCode: string): { isValid: boolean; error?: string; e164Format?: string } {
      if (!phoneNumber || !countryCode) {
        return { isValid: false, error: 'Phone number and country code are required' };
      }

      // For US/Canada (+1), remove leading "1" if present (country code already includes +1)
      // Remove if starts with 1 and has more than just the "1" (at least 2 digits)
      let cleanPhoneNumber = phoneNumber;
      if (countryCode === '+1' && phoneNumber.startsWith('1') && phoneNumber.length >= 2) {
        cleanPhoneNumber = phoneNumber.substring(1);
        console.log('üîç [Validate] Removed leading 1 from US number, digits now:', cleanPhoneNumber);
      }

      // Convert country code (e.g., "+1") to country code (e.g., "US")
      const countryCodeMap: Record<string, string> = {
        '+1': 'US',
        '+44': 'GB',
        '+33': 'FR',
        '+49': 'DE',
        '+39': 'IT',
        '+34': 'ES',
        '+31': 'NL',
        '+32': 'BE',
        '+41': 'CH',
        '+43': 'AT',
        '+45': 'DK',
        '+46': 'SE',
        '+47': 'NO',
        '+358': 'FI',
        '+48': 'PL',
        '+353': 'IE',
        '+351': 'PT',
        '+30': 'GR',
        '+90': 'TR',
        '+7': 'RU',
        '+380': 'UA',
        '+86': 'CN',
        '+81': 'JP',
        '+82': 'KR',
        '+886': 'TW',
        '+852': 'HK',
        '+65': 'SG',
        '+60': 'MY',
        '+66': 'TH',
        '+62': 'ID',
        '+63': 'PH',
        '+84': 'VN',
        '+91': 'IN',
        '+92': 'PK',
        '+880': 'BD',
        '+52': 'MX',
        '+55': 'BR',
        '+54': 'AR',
        '+56': 'CL',
        '+57': 'CO',
        '+51': 'PE',
        '+58': 'VE',
        '+593': 'EC',
        '+598': 'UY',
        '+595': 'PY',
        '+591': 'BO',
        '+506': 'CR',
        '+507': 'PA',
        '+502': 'GT',
        '+504': 'HN',
        '+503': 'SV',
        '+505': 'NI',
        '+53': 'CU',
        '+234': 'NG',
        '+254': 'KE',
        '+233': 'GH',
        '+972': 'IL',
        '+971': 'AE',
        '+966': 'SA',
        '+20': 'EG',
        '+27': 'ZA',
        '+61': 'AU',
        '+64': 'NZ'
      };

      const country = countryCodeMap[countryCode] || 'US';
      const fullPhoneNumber = `${countryCode}${cleanPhoneNumber}`;

      // Try to use libphonenumber-js if available
      if (libphonenumber) {
        try {
          const { parsePhoneNumber, AsYouType } = libphonenumber;
          
          // Try parsing with country code
          const parsed = parsePhoneNumber(fullPhoneNumber, country as any);
          
          if (parsed && parsed.isValid()) {
            return {
              isValid: true,
              e164Format: parsed.format('E.164')
            };
          } else {
            return {
              isValid: false,
              error: `Invalid phone number. Please check the format for ${countryCode}.`
            };
          }
        } catch (error) {
          console.warn('libphonenumber validation failed, using fallback:', error);
        }
      }
      
      // Fallback validation without libphonenumber
      // Must start with +
      if (!fullPhoneNumber.startsWith('+')) {
        return { isValid: false, error: 'Phone number must start with +' };
      }

      // Extract digits after +
      const digits = fullPhoneNumber.slice(1);
      
      // Must contain only digits
      if (!/^\d+$/.test(digits)) {
        return { isValid: false, error: 'Phone number must contain only digits' };
      }

      // Must be between 7 and 15 digits (E.164 standard)
      if (digits.length < 7 || digits.length > 15) {
        return { 
          isValid: false, 
          error: 'Phone number must be between 7 and 15 digits' 
        };
      }

      return { isValid: true, e164Format: fullPhoneNumber };
    }

    // [DEV-HOTFIX] Ensure changePhoneBtn exists before any event listeners
    if (typeof window !== 'undefined' && !('changePhoneBtn' in window)) {
      try {
        Object.defineProperty(window, 'changePhoneBtn', {
          get: function() { return document.getElementById('change-phone'); },
          configurable: true,
          enumerable: false
        });
      } catch(e) {
        (window as any).changePhoneBtn = null;
      }
    }
    
    // REAL-TIME PHONE FORMATTING using libphonenumber-js AsYouType
    if (phoneInputStep1) {
      console.log('‚úÖ Setting up phone formatting with libphonenumber-js...');
      
      const phoneInput = phoneInputStep1 as HTMLInputElement;
      
      // CRITICAL: Apply visibility using MULTIPLE methods for maximum compatibility
      // Method 1: Direct style property manipulation (most reliable)
      phoneInput.style.color = '#111827';
      phoneInput.style.backgroundColor = '#ffffff';
      phoneInput.style.opacity = '1';
      phoneInput.style.visibility = 'visible';
      phoneInput.style.display = 'block';
      
      // Method 2: setProperty with important flag
      phoneInput.style.setProperty('color', '#111827', 'important');
      phoneInput.style.setProperty('background-color', '#ffffff', 'important');
      phoneInput.style.setProperty('opacity', '1', 'important');
      phoneInput.style.setProperty('-webkit-text-fill-color', '#111827', 'important');
      phoneInput.style.setProperty('caret-color', '#111827', 'important');
      phoneInput.style.setProperty('visibility', 'visible', 'important');
      
      // Method 3: setAttribute (fallback for older browsers)
      const styleAttr = 'color: #111827 !important; background-color: #ffffff !important; opacity: 1 !important; -webkit-text-fill-color: #111827 !important; caret-color: #111827 !important; visibility: visible !important;';
      phoneInput.setAttribute('style', phoneInput.getAttribute('style') + '; ' + styleAttr);
      
      // CRITICAL: Remove any classes that might hide text
      phoneInput.classList.remove('text-transparent', 'opacity-0', 'invisible', 'hidden', 'opacity-[0]');
      
      // Force browser reflow to apply styles
      void phoneInput.offsetHeight;
      
      // Verify visibility
      const computed = window.getComputedStyle(phoneInput);
      console.log('üîç Input visibility check:', {
        color: computed.color,
        opacity: computed.opacity,
        visibility: computed.visibility,
        display: computed.display,
        webkitTextFillColor: computed.webkitTextFillColor || 'N/A',
        computedStyle: computed
      });
      
      // Helper function to convert country code to ISO code
      const getCountryFromCode = (code: string): string => {
        const countryCodeMap: Record<string, string> = {
          '+1': 'US', '+44': 'GB', '+33': 'FR', '+49': 'DE', '+39': 'IT',
          '+34': 'ES', '+31': 'NL', '+32': 'BE', '+41': 'CH', '+43': 'AT',
          '+45': 'DK', '+46': 'SE', '+47': 'NO', '+358': 'FI', '+48': 'PL',
          '+353': 'IE', '+351': 'PT', '+30': 'GR', '+90': 'TR', '+7': 'RU',
          '+380': 'UA', '+86': 'CN', '+81': 'JP', '+82': 'KR', '+886': 'TW',
          '+852': 'HK', '+91': 'IN', '+61': 'AU', '+64': 'NZ', '+27': 'ZA',
          '+971': 'AE', '+966': 'SA', '+20': 'EG', '+234': 'NG', '+254': 'KE',
          '+233': 'GH', '+972': 'IL'
        };
        return countryCodeMap[code] || 'US';
      };
      
      // REAL-TIME FORMATTING: Format phone number as user types using libphonenumber-js
      let isFormatting = false;
      let formatTimeout: NodeJS.Timeout | null = null;
      
      const formatPhoneNumber = async (value: string, countryCode: string): Promise<string> => {
        if (!countryCode || !value) return value;
        
        let cleanDigits = value.replace(/\D/g, '');
        if (cleanDigits.length === 0) return value;
        
        // For US/Canada (+1), remove leading "1" if present (country code already includes +1)
        // Remove if starts with 1 and has more than just the "1" (at least 2 digits)
        if (countryCode === '+1' && cleanDigits.startsWith('1') && cleanDigits.length >= 2) {
          cleanDigits = cleanDigits.substring(1);
          console.log('üîç [Format] Removed leading 1 from US number, digits now:', cleanDigits);
        }
        
        try {
          const lib = await loadLibPhoneNumber();
          if (lib && lib.AsYouType) {
            const country = getCountryFromCode(countryCode);
            const asYouType = new lib.AsYouType(country);
            const formatted = asYouType.input(cleanDigits);
            return formatted || value;
          }
        } catch (error) {
          console.warn('Phone formatting error:', error);
        }
        
        return value;
      };
      
      phoneInput.addEventListener('input', function(e) {
        if (isFormatting) return;
        
        // Debounce formatting to avoid too many calls
        if (formatTimeout) {
          clearTimeout(formatTimeout);
        }
        
        formatTimeout = setTimeout(async () => {
          const input = this as HTMLInputElement;
          const countrySelect = countryCodeStep1 as HTMLSelectElement;
          const selectedCountryCode = countrySelect?.value;
          
          if (!selectedCountryCode) {
            return;
          }
          
          const currentValue = input.value;
          const cursorPos = input.selectionStart || 0;
          
          isFormatting = true;
          const formatted = await formatPhoneNumber(currentValue, selectedCountryCode);
          
          if (formatted !== currentValue && formatted) {
            input.value = formatted;
            
            // Try to restore cursor position
            const lengthDiff = formatted.length - currentValue.length;
            const newCursorPos = Math.min(Math.max(0, cursorPos + lengthDiff), formatted.length);
            
            setTimeout(() => {
              input.setSelectionRange(newCursorPos, newCursorPos);
              isFormatting = false;
            }, 0);
          } else {
            isFormatting = false;
          }
        }, 150); // Debounce 150ms
      });
      
      // Format phone when country code changes
      if (countryCodeStep1) {
        countryCodeStep1.addEventListener('change', async function() {
          const input = phoneInput as HTMLInputElement;
          const selectedCountryCode = (this as HTMLSelectElement).value;
          
          if (selectedCountryCode && input.value) {
            const cleanDigits = input.value.replace(/\D/g, '');
            if (cleanDigits.length > 0) {
              const formatted = await formatPhoneNumber(cleanDigits, selectedCountryCode);
              if (formatted) {
                input.value = formatted;
              }
            }
          }
        });
      }
      
      // Format on blur with full validation
      phoneInput.addEventListener('blur', async function(e) {
        // Don't process if clicking the Continue button
        const relatedTarget = (e as any).relatedTarget;
        if (relatedTarget && (
          relatedTarget.id === 'check-user-btn' || 
          relatedTarget.closest && relatedTarget.closest('#check-user-btn')
        )) {
          console.log('üîç Blur detected from Continue button - skipping formatting');
          return;
        }
        
        const input = this as HTMLInputElement;
        const countrySelect = countryCodeStep1 as HTMLSelectElement;
        const selectedCountryCode = countrySelect?.value;
        
        if (!selectedCountryCode) {
          return;
        }
        
        const currentValue = input.value;
        const cleanDigits = currentValue.replace(/\D/g, '');
        
        // Validate and format using libphonenumber-js
        try {
          const lib = await loadLibPhoneNumber();
          if (lib && lib.parsePhoneNumber) {
            const country = getCountryFromCode(selectedCountryCode);
            const fullNumber = `${selectedCountryCode}${cleanDigits}`;
            
            try {
              const parsed = lib.parsePhoneNumber(fullNumber, country as any);
              if (parsed && parsed.isValid()) {
                // Format as national format for better UX
                input.value = parsed.formatNational();
                input.style.borderColor = '#10b981'; // Green border for valid
                setTimeout(() => {
                  input.style.borderColor = '';
                }, 2000);
              } else {
                // Invalid number - show error styling
                input.style.borderColor = '#ef4444'; // Red border
                setTimeout(() => {
                  input.style.borderColor = '';
                }, 3000);
              }
            } catch (parseError) {
              // Invalid number format
              input.style.borderColor = '#ef4444';
              setTimeout(() => {
                input.style.borderColor = '';
              }, 3000);
            }
          }
        } catch (error) {
          console.warn('Phone validation error:', error);
        }
        
        // Re-apply visibility
        input.style.color = '#111827';
        input.style.setProperty('-webkit-text-fill-color', '#111827', 'important');
      }, { passive: true });
      
      // Handle paste to clean non-digits
      phoneInput.addEventListener('paste', function(e) {
        e.preventDefault();
        const paste = (e.clipboardData || (window as any).clipboardData).getData('text');
        const digits = paste.replace(/\D/g, '').substring(0, 15);
        
        if (digits) {
          const start = phoneInput.selectionStart || 0;
          const end = phoneInput.selectionEnd || 0;
          const currentValue = phoneInput.value;
          const newValue = currentValue.substring(0, start) + digits + currentValue.substring(end);
          const limited = newValue.replace(/\D/g, '').substring(0, 15);
          
          phoneInput.value = limited;
          
          // Maintain cursor position
          setTimeout(() => {
            const newPos = Math.min(start + digits.length, limited.length);
            phoneInput.setSelectionRange(newPos, newPos);
          }, 0);
        }
      }, { passive: false });
      
      // Monitor for visibility issues (debug only)
      const checkVisibility = () => {
        const computed = window.getComputedStyle(phoneInput);
        if (computed.color === 'rgb(0, 0, 0)' || computed.color === 'rgba(0, 0, 0, 0)' || computed.opacity === '0') {
          console.warn('‚ö†Ô∏è Visibility issue detected! Reapplying styles...');
          phoneInput.setAttribute('style', 'color: #111827 !important; background-color: #ffffff !important; opacity: 1 !important; -webkit-text-fill-color: #111827 !important; caret-color: #111827 !important;');
        }
      };
      
      // Check visibility periodically (only in development)
      if (window.location.hostname === 'localhost') {
        setInterval(checkVisibility, 1000);
      }
      
      console.log('‚úÖ Phone input handler attached with real-time formatting');
    }
      
    
    // Title elements
    const modalTitle = document.getElementById('auth-modal-title');
    const modalSubtitle = document.getElementById('auth-modal-subtitle');
    
    // Step 1 elements
    const industrySelect = document.getElementById('industry-select');
    const roleSelect = document.getElementById('role-select');
    const roleStatus = document.getElementById('role-status');
    const organizationInput = document.getElementById('unified-organization-input');
    const continueToPhoneBtn = document.getElementById('continue-to-phone');
    const cancelAuthBtn = document.getElementById('cancel-auth');
    
    // Step 2 elements - CRITICAL: Scope to unified-auth-modal to avoid conflicts with 2FAModal
    const phoneForm = modal?.querySelector('#unified-phone-form') as HTMLFormElement || document.getElementById('unified-phone-form') as HTMLFormElement;
    const countryCodeSelect = modal?.querySelector('#country-code') as HTMLSelectElement || document.getElementById('country-code') as HTMLSelectElement;
    const phoneNumberInput = modal?.querySelector('#unified-auth-phone-number') as HTMLInputElement || document.getElementById('unified-auth-phone-number') as HTMLInputElement;
    
    // CRITICAL: Prevent form submission completely
    if (phoneForm) {
      phoneForm.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        console.log('üö´ Form submit prevented');
        return false;
      }, true); // Use capture phase to catch early
    }
    const sendSmsBtn = document.getElementById('send-sms-btn');
    const sendCallBtn = document.getElementById('send-call-btn');
    const sendWhatsappBtn = document.getElementById('send-whatsapp-btn');
    const sendFlashcallBtn = document.getElementById('send-flashcall-btn');
    const backToIndustryBtn = document.getElementById('back-to-industry');
    const backToPhoneBtn = document.getElementById('back-to-phone');
    const skipPhoneBtn = document.getElementById('skip-phone');
    
    // Step 3 elements (Send Verification Code) - Note: These are now in step3 div
    const step3PhoneDisplay = document.getElementById('display-phone-number');
    const step4PhoneDisplay = document.getElementById('display-phone-number-otp');
    
    // Step 4 elements (OTP Verification)
    const otpForm = document.getElementById('otp-form');
    const verificationCodeInput = document.getElementById('unified-verification-code');
    const verifyCodeBtn = document.getElementById('unified-verify-code-btn');
    const resendCodeBtn = document.getElementById('resend-code-btn');
    const resendTimer = document.getElementById('resend-timer');
    const countdownSpan = document.getElementById('countdown');
    const displayPhoneNumberOtp = document.getElementById('display-phone-number-otp');
    const backToPhoneVerificationBtn = document.getElementById('back-to-phone-verification');
    const changePhoneNumberBtn = document.getElementById('change-phone-number');
    // CRITICAL: Always get fresh reference, never rely on scope - prevents "not defined" errors
    const getChangePhoneBtn = () => document.getElementById('change-phone');
    const changePhoneBtn = getChangePhoneBtn();
    
    // Error/Success elements
    const errorDiv = document.getElementById('auth-error');
    const successDiv = document.getElementById('auth-success');
    const loadingDiv = document.getElementById('auth-loading');
    const errorMessage = document.getElementById('auth-error-message');
    const successMessage = document.getElementById('auth-success-message');

    let currentStep = 1;
    let isNewUser = false;
    let currentVerificationId: string | null = null;
    let currentPhoneNumber: string | null = null;
    let currentCountryCode: string | null = null;
    let resendTimerInterval: NodeJS.Timeout | null = null;

    // Helper functions
    function updateProgressIndicators() {
      // Determine total steps based on user type
      const totalSteps = isNewUser ? 4 : 3;
      
      // Show/hide indicators based on user type
      stepIndicator2?.classList.toggle('hidden', !isNewUser);
      stepIndicator4?.classList.toggle('hidden', !isNewUser);
      
      // Update indicators for current step
      [stepIndicator1, stepIndicator2, stepIndicator3, stepIndicator4].forEach((indicator, index) => {
        if (indicator && !indicator.classList.contains('hidden')) {
          const stepIndex = index + 1;
          if (stepIndex <= currentStep) {
            indicator.classList.remove('bg-white/30');
            indicator.classList.add('bg-white');
          } else {
            indicator.classList.remove('bg-white');
            indicator.classList.add('bg-white/30');
          }
        }
      });
      
      // Update step description
      if (stepDescription) {
        stepDescription.textContent = `Step ${currentStep} of ${totalSteps}`;
      }
    }
    
    function showStep(stepNum: number) {
      console.log(`üîÑ showStep(${stepNum}) called`);
      
      // Hide all steps
      [step1, step2, step3, step4].forEach(s => s?.classList.add('hidden'));
      
      // Show current step
      const currentStepElement = document.getElementById(`auth-step-${stepNum}`);
      console.log(`üîç Step ${stepNum} element:`, {
        exists: !!currentStepElement,
        id: currentStepElement?.id,
        classes: currentStepElement?.className
      });
      
      if (currentStepElement) {
        currentStepElement.classList.remove('hidden');
        console.log(`‚úÖ Step ${stepNum} shown, classes after:`, currentStepElement.className);
      } else {
        console.error(`‚ùå Step ${stepNum} element not found!`);
      }
      
      currentStep = stepNum;
      updateProgressIndicators();
      
      // CRITICAL: Clear loading/error messages when switching steps
      hideAllMessages();

      // Ensure inputs are interactive and continue button state is correct
      if (currentStep === 2) {
        // CRITICAL: Setup and enable firstName and lastName inputs
        // Use setTimeout to ensure DOM is fully rendered
        setTimeout(() => {
          const firstNameInput = document.getElementById('first-name-input') as HTMLInputElement;
          const lastNameInput = document.getElementById('last-name-input') as HTMLInputElement;
          
          if (firstNameInput) {
            // Remove any blocking attributes
            firstNameInput.removeAttribute('disabled');
            firstNameInput.removeAttribute('readonly');
            firstNameInput.readOnly = false;
            firstNameInput.disabled = false;
            
            // Force enable all input-related styles
            firstNameInput.style.setProperty('pointer-events', 'auto', 'important');
            firstNameInput.style.setProperty('cursor', 'text', 'important');
            firstNameInput.style.setProperty('user-select', 'text', 'important');
            firstNameInput.style.setProperty('-webkit-user-select', 'text', 'important');
            firstNameInput.style.setProperty('opacity', '1', 'important');
            firstNameInput.style.setProperty('color', '#111827', 'important');
            
            // Ensure it can receive focus
            firstNameInput.tabIndex = 0;
            
            console.log('‚úÖ FirstName input enabled in step 2:', {
              disabled: firstNameInput.disabled,
              readOnly: firstNameInput.readOnly,
              pointerEvents: window.getComputedStyle(firstNameInput).pointerEvents,
              value: firstNameInput.value
            });
            
            // Focus if empty
            if (!firstNameInput.value) {
              setTimeout(() => firstNameInput.focus(), 50);
            }
          }
          
          if (lastNameInput) {
            // Remove any blocking attributes
            lastNameInput.removeAttribute('disabled');
            lastNameInput.removeAttribute('readonly');
            lastNameInput.readOnly = false;
            lastNameInput.disabled = false;
            
            // Force enable all input-related styles
            lastNameInput.style.setProperty('pointer-events', 'auto', 'important');
            lastNameInput.style.setProperty('cursor', 'text', 'important');
            lastNameInput.style.setProperty('user-select', 'text', 'important');
            lastNameInput.style.setProperty('-webkit-user-select', 'text', 'important');
            lastNameInput.style.setProperty('opacity', '1', 'important');
            lastNameInput.style.setProperty('color', '#111827', 'important');
            
            // Ensure it can receive focus
            lastNameInput.tabIndex = 0;
            
            console.log('‚úÖ LastName input enabled in step 2:', {
              disabled: lastNameInput.disabled,
              readOnly: lastNameInput.readOnly,
              pointerEvents: window.getComputedStyle(lastNameInput).pointerEvents,
              value: lastNameInput.value
            });
          }
          
          // Re-run setup to ensure event listeners are attached
          if (typeof (window as any).__setupNameInputs === 'function') {
            (window as any).__setupNameInputs();
          }
        }, 100);
        
        // CRITICAL: Reset industry select to default (empty) unless it's a returning user
        const industrySelectEl = document.getElementById('industry-select') as HTMLSelectElement;
        if (industrySelectEl) {
          // Only reset if this is a new user (not a returning user with pre-filled data)
          // Check if the value is already set from user lookup - if not, reset to empty
          const hasStoredValue = industrySelectEl.value && industrySelectEl.value !== '';
          if (!hasStoredValue) {
            industrySelectEl.value = ''; // Reset to "Choose your industry..."
            // Also reset role select
            const roleSelectEl = document.getElementById('role-select') as HTMLSelectElement;
            if (roleSelectEl) {
              roleSelectEl.innerHTML = '<option value="">Choose your role...</option>';
              roleSelectEl.disabled = true;
            }
          }
        }
        
        // Attach Continue button handler when step 2 is shown
        // CRITICAL: Ensure handler is attached and button is enabled
        setTimeout(() => {
          // Always call attach handler to ensure button is clickable
          attachContinueButtonHandler();
          
          if (typeof (window as any).__attachContinueButtonOnStep2 === 'function') {
            (window as any).__attachContinueButtonOnStep2();
          }
          
          // Also directly call updateContinueButton multiple times to ensure state
          updateContinueButton();
          
          // Force button to be enabled and clickable (ALWAYS, not just when fields are filled)
          const continueBtn = document.getElementById('continue-to-otp') as HTMLButtonElement;
          
          if (continueBtn) {
            // ALWAYS remove disabled attribute and force clickability
            continueBtn.removeAttribute('disabled');
            continueBtn.disabled = false;
            continueBtn.style.setProperty('pointer-events', 'auto', 'important');
            continueBtn.style.setProperty('cursor', 'pointer', 'important');
            continueBtn.style.opacity = '1';
            continueBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            
            const industryEl = document.getElementById('industry-select') as HTMLSelectElement;
            const roleEl = document.getElementById('role-select') as HTMLSelectElement;
            const orgEl = document.getElementById('unified-organization-input') as HTMLInputElement;
            const hasAllFields = !!(industryEl?.value?.trim() && roleEl?.value?.trim() && orgEl?.value?.trim());
            
            console.log('üîß Force-enabled Continue button in showStep(2)', { 
              hasAllFields,
              disabled: continueBtn.disabled,
              pointerEvents: continueBtn.style.pointerEvents,
              hasDisabledAttr: continueBtn.hasAttribute('disabled')
            });
          }
        }, 50);
        
        // Focus organization input for quick entry
        let org = document.getElementById('unified-organization-input') as HTMLInputElement;
        // Declare these outside the if block so they're accessible later
        let isFocused = false;
        let hasValue = false;
        
        if (org) {
          // Only replace if element doesn't already have proper setup
          // Don't replace if user is currently typing
          isFocused = document.activeElement === org;
          hasValue = !!(org.value && org.value.length > 0);
          
          // Only clone/replace if the element appears to be non-interactive
          if (!hasValue && !isFocused) {
            // Replace with a fresh clone to drop any stale listeners/properties
            const fresh = org.cloneNode(true) as HTMLInputElement;
            fresh.id = 'unified-organization-input';
            fresh.name = org.name || 'organization';
            fresh.autocomplete = 'organization';
            fresh.required = true;
            // Ensure maximum interactivity
            fresh.removeAttribute('disabled');
            fresh.readOnly = false;
            fresh.tabIndex = 0;
            fresh.style.pointerEvents = 'auto';
            fresh.style.userSelect = 'text';
            fresh.style.position = 'relative';
            fresh.style.zIndex = '20';
            fresh.style.color = '#111827';
            fresh.style.backgroundColor = '#ffffff';
            fresh.style.setProperty('-webkit-text-fill-color', '#111827', 'important');
            org.parentElement?.replaceChild(fresh, org);
            org = fresh;
          } else {
            // Just ensure properties are correct without replacing
            org.removeAttribute('disabled');
            org.readOnly = false;
            org.tabIndex = 0;
            org.style.pointerEvents = 'auto';
            org.style.userSelect = 'text';
            org.style.position = 'relative';
            org.style.zIndex = '20';
            org.style.color = '#111827';
            org.style.backgroundColor = '#ffffff';
            org.style.setProperty('-webkit-text-fill-color', '#111827', 'important');
          }
          
          // Defensive: ensure no overlay blocks interaction
          const modalEl = document.getElementById('unified-auth-modal');
          modalEl?.classList.remove('disable-pointer');
          (modalEl?.parentElement)?.classList.remove('disable-pointer');
          // Remove any stray disable-pointer classes globally
          document.querySelectorAll('.disable-pointer').forEach((n:any)=> n.classList.remove('disable-pointer'));
          // Ensure step 2 container is interactive and above overlays
          const step2 = document.getElementById('auth-step-2') as HTMLElement;
          if (step2) {
            step2.style.pointerEvents = 'auto';
            step2.style.position = 'relative';
            step2.style.zIndex = '20';
          }
          // Reattach listeners to the fresh input
          org.addEventListener('input', () => {
            console.log('üìù Org input (fresh):', org.value);
            updateContinueButton();
          }, { capture: false, passive: true });
          org.addEventListener('keyup', updateContinueButton, { capture: false });
          org.addEventListener('change', updateContinueButton, { capture: false });
          org.addEventListener('compositionend', updateContinueButton, { capture: false });
          org.addEventListener('keydown', (e: KeyboardEvent) => {
            if (e.key === 'Enter') { 
              e.preventDefault(); 
              const btn = document.getElementById('continue-to-otp') as HTMLButtonElement;
              if (btn && !btn.disabled) {
                btn.click(); 
              }
            }
          });
        } else {
          // Even if not replaced, ensure listeners are attached
          attachOrgInputListeners();
          // Update isFocused and hasValue for the else branch
          if (org) {
            isFocused = document.activeElement === org;
            hasValue = !!(org.value && org.value.length > 0);
          }
        }
        
        // Only focus if not already focused and no value (and org exists)
        if (org && !isFocused && !hasValue) {
          setTimeout(() => org.focus(), 0);
        }
        // Re-evaluate visual enable state immediately and aggressively
        updateContinueButton();
        setTimeout(() => updateContinueButton(), 50);
        setTimeout(() => updateContinueButton(), 200);
        setTimeout(() => updateContinueButton(), 500);
      } else if (currentStep === 4) {
        // Step 4: OTP Verification - Ensure input is visible and interactive
        // CRITICAL: Only run this once per step 4 display, don't interfere with user typing
        const step4SetupKey = '__step4SetupDone';
        if ((window as any)[step4SetupKey]) {
          // Already set up, just ensure visibility styles
          const otpInput = document.getElementById('unified-verification-code') as HTMLInputElement;
          if (otpInput) {
            otpInput.style.setProperty('-webkit-text-fill-color', '#111827', 'important');
            otpInput.style.setProperty('caret-color', '#111827', 'important');
          }
          return;
        }
        
        setTimeout(() => {
          const otpInput = document.getElementById('unified-verification-code') as HTMLInputElement;
          if (otpInput) {
            // Mark as setup to prevent repeated runs
            (window as any)[step4SetupKey] = true;
            
            // Always apply visibility styles first
            otpInput.removeAttribute('disabled');
            otpInput.readOnly = false;
            otpInput.tabIndex = 0;
            otpInput.style.pointerEvents = 'auto';
            otpInput.style.userSelect = 'text';
            otpInput.style.position = 'relative';
            otpInput.style.zIndex = '20';
            otpInput.style.color = '#111827';
            otpInput.style.backgroundColor = '#ffffff';
            otpInput.style.opacity = '1';
            otpInput.style.setProperty('-webkit-text-fill-color', '#111827', 'important');
            otpInput.style.setProperty('caret-color', '#111827', 'important');
            
            // Add input handler to clean/format the code (numbers only)
            const formatOTPInput = (e?: Event) => {
              const input = (e?.target as HTMLInputElement) || otpInput;
              const value = input.value;
              const cleaned = value.replace(/\D/g, '').slice(0, 5); // Only digits, max 5 (Telnyx uses 5-digit codes)
              
              // Only update if there's a change (preserves cursor position)
              if (value !== cleaned) {
                const cursorPos = input.selectionStart || 0;
                input.value = cleaned;
                // Restore cursor position after cleaning
                const newCursorPos = Math.min(cursorPos, cleaned.length);
                input.setSelectionRange(newCursorPos, newCursorPos);
              }
            };
            
            // Attach format handler if not already attached (check for marker)
            const hasInputHandler = (otpInput as any).__hasFormatHandler;
            if (!hasInputHandler) {
              otpInput.addEventListener('input', formatOTPInput, { capture: false, passive: true });
              otpInput.addEventListener('keypress', (e) => {
                // Only allow numbers
                if (!/[0-9]/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'Tab') {
                  e.preventDefault();
                }
              }, { capture: false });
              (otpInput as any).__hasFormatHandler = true;
              console.log('‚úÖ OTP input handlers attached');
            }
            
            // Auto-focus if empty
            const currentValue = otpInput.value || '';
            if (!currentValue) {
              setTimeout(() => {
                otpInput.focus();
                console.log('‚úÖ OTP input focused');
              }, 100);
            }
            
            // Update the module-level reference for the verification handler
            (window as any).__verificationCodeInput = otpInput;
            console.log('‚úÖ OTP input reference updated:', otpInput.id, 'value:', currentValue ? `${currentValue.length} chars` : 'empty');
          }
        }, 50);
        
        // CRITICAL: Force enable button if all fields are filled, regardless of current state
        const forceEnableCheck = setInterval(() => {
          const industryEl = document.getElementById('industry-select') as HTMLSelectElement;
          const roleEl = document.getElementById('role-select') as HTMLSelectElement;
          const orgEl = document.getElementById('unified-organization-input') as HTMLInputElement;
          const continueBtn = document.getElementById('continue-to-otp') as HTMLButtonElement;
          
          if (!continueBtn || !industryEl || !roleEl || !orgEl) {
            clearInterval(forceEnableCheck);
            return;
          }
          
          const hasAllFields = !!(industryEl.value?.trim() && roleEl.value?.trim() && orgEl.value?.trim());
          
          if (hasAllFields && continueBtn.disabled) {
            console.log('üîß Force-enabling button (polling check)');
            continueBtn.removeAttribute('disabled');
            continueBtn.disabled = false;
            continueBtn.style.opacity = '1';
            continueBtn.style.pointerEvents = 'auto';
            continueBtn.style.cursor = 'pointer';
            continueBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            // Re-attach handler in case it was lost
            attachContinueButtonHandler();
          }
          
          // Stop polling if step 2 is hidden
          if (document.getElementById('auth-step-2')?.classList.contains('hidden')) {
            clearInterval(forceEnableCheck);
          }
        }, 200); // Poll every 200ms
        
        // Also use the existing watcher
        if (!step2Watcher) {
          step2Watcher = window.setInterval(() => {
            // Only poll while step 2 is visible
            const visible = !document.getElementById('auth-step-2')?.classList.contains('hidden');
            if (!visible) { 
              if (step2Watcher) { 
                clearInterval(step2Watcher); 
                step2Watcher = null; 
              } 
              return; 
            }
            updateContinueButton();
          }, 300); // Poll every 300ms
        }
      }
    }

    // CRITICAL: Expose showStep to window for use by resetModal
    // Do this IMMEDIATELY after function definition, before any code uses it
    (window as any).showStep = showStep;

    function showError(message: string) {
      if (errorMessage) errorMessage.textContent = message;
      errorDiv?.classList.remove('hidden');
      successDiv?.classList.add('hidden');
      loadingDiv?.classList.add('hidden');
    }

    function showSuccess(message: string) {
      if (successMessage) successMessage.textContent = message;
      successDiv?.classList.remove('hidden');
      errorDiv?.classList.add('hidden');
      loadingDiv?.classList.add('hidden');
    }

    function showLoading() {
      loadingDiv?.classList.remove('hidden');
      errorDiv?.classList.add('hidden');
      successDiv?.classList.add('hidden');
    }

    function hideAllMessages() {
      errorDiv?.classList.add('hidden');
      successDiv?.classList.add('hidden');
      loadingDiv?.classList.add('hidden');
    }
    
    // CRITICAL: Expose hideAllMessages immediately after definition
    (window as any).hideAllMessages = hideAllMessages;

    // Track pending requests to prevent multiple simultaneous requests
    let pendingVerificationRequest: Promise<any> | null = null;
    let lastRequestTime = 0;
    const REQUEST_COOLDOWN = 2000; // 2 seconds minimum between requests
    
    function sendVerificationCode(method: string) {
      // Ensure we have a phone number - try to get it from currentPhoneNumber or form inputs
      if (!currentPhoneNumber) {
        // Fallback: Try to get phone number from form inputs (Step 1)
        const phoneNumber = (phoneNumberInput as HTMLInputElement)?.value;
        const countryCode = (countryCodeSelect as HTMLSelectElement)?.value;
        
        if (phoneNumber && countryCode) {
          currentPhoneNumber = `${countryCode}${phoneNumber}`;
          currentCountryCode = countryCode;
          console.log('üì± Retrieved phone number from form inputs:', currentPhoneNumber);
        } else {
          showError('Phone number not available. Please go back and enter your phone number.');
          return;
        }
      }

      // Prevent rapid clicks - check cooldown
      const now = Date.now();
      const timeSinceLastRequest = now - lastRequestTime;
      if (timeSinceLastRequest < REQUEST_COOLDOWN && pendingVerificationRequest) {
        const waitSeconds = Math.ceil((REQUEST_COOLDOWN - timeSinceLastRequest) / 1000);
        showError(`Please wait ${waitSeconds} second${waitSeconds > 1 ? 's' : ''} before requesting another code`);
        return Promise.resolve();
      }

      // If there's already a pending request, wait for it
      if (pendingVerificationRequest) {
        console.log('‚ö†Ô∏è Request already in progress, waiting...');
        return pendingVerificationRequest.catch(() => {
          // Don't show error if it was just a duplicate request
          return null;
        });
      }

      showLoading();
      lastRequestTime = now;
      
      // Disable all OTP method buttons during request
      const buttonIds = ['send-sms-btn', 'send-call-btn', 'send-whatsapp-btn', 'send-flashcall-btn'];
      const enableButtons = () => {
        buttonIds.forEach(btnId => {
          const btn = document.getElementById(btnId) as HTMLButtonElement;
          if (btn) {
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
          }
        });
      };
      
      buttonIds.forEach(btnId => {
        const btn = document.getElementById(btnId) as HTMLButtonElement;
        if (btn) {
          btn.disabled = true;
          btn.style.opacity = '0.6';
          btn.style.cursor = 'not-allowed';
        }
      });

      // Use relative path as per original architecture (Astro API routes handle directly)
      const requestPromise = fetch('/api/v2/2fa/initiate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          phoneNumber: currentPhoneNumber,
          method: method,
          userAgent: navigator.userAgent,
          ipAddress: '127.0.0.1',
          sessionId: 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now()
        })
      })
      .then(async response => {
        // Read response body as text first (can only read once)
        const responseText = await response.text();
        
        // Check if response is OK
        if (!response.ok) {
          // Try to parse error response
          let errorMessage = `Server error: ${response.status} ${response.statusText}`;
          if (responseText && responseText.trim()) {
            try {
              const errorResult = JSON.parse(responseText);
              errorMessage = errorResult?.error?.message || errorResult?.error || errorResult?.message || errorMessage;
              
              // Handle rate limiting specifically
              if (response.status === 429 || errorMessage.toLowerCase().includes('rate limit') || errorMessage.toLowerCase().includes('too many requests')) {
                const retryAfter = response.headers.get('Retry-After') || errorResult?.retryAfter || errorResult?.waitTime;
                if (retryAfter) {
                  const waitSeconds = parseInt(retryAfter, 10);
                  const waitMinutes = Math.ceil(waitSeconds / 60);
                  errorMessage = `Too many requests. Please wait ${waitMinutes} minute${waitMinutes > 1 ? 's' : ''} before trying again.`;
                } else {
                  // Extract wait time from error message if available
                  const waitMatch = errorMessage.match(/(\d+)\s*(?:minute|min)/i);
                  if (!waitMatch) {
                    errorMessage = 'Too many requests. Please wait before trying again.';
                  }
                }
              }
            } catch (parseError) {
              // If JSON parsing fails, use status text
              console.error('Failed to parse error response:', parseError, 'Response text:', responseText.substring(0, 200));
            }
          }
          throw new Error(errorMessage);
        }
        
        // Parse successful response
        if (!responseText || responseText.trim() === '') {
          throw new Error('Empty response from server');
        }
        
        let result;
        try {
          result = JSON.parse(responseText);
          
          // CRITICAL: Log the RAW response text first
          console.log(`üì• [${method}] RAW response text (first 500 chars):`, responseText.substring(0, 500));
          console.log(`üì• [${method}] Full response text length:`, responseText.length);
          console.log(`‚úÖ [${method}] API response parsed successfully:`, {
            success: result.success,
            hasData: !!result.data,
            verificationId: result.verificationId || result.data?.verificationId || 'not present',
            resultKeys: Object.keys(result),
            fullResult: result, // Show the FULL response structure
            resultStringified: JSON.stringify(result, null, 2) // Full JSON for inspection
          });
          
          // CRITICAL: Check if verificationId exists in the parsed result
          console.log(`üîç [${method}] VerificationId check:`, {
            'result.verificationId': result.verificationId,
            'result.data?.verificationId': result.data?.verificationId,
            'hasVerificationId': !!(result.verificationId || result.data?.verificationId),
            'resultType': typeof result,
            'resultKeys': Object.keys(result)
          });
        } catch (parseError) {
          console.error('Failed to parse response JSON:', parseError, 'Response text:', responseText.substring(0, 500));
          throw new Error('Invalid response from server. Please try again.');
        }
        
        return result;
      })
      .finally(() => {
        // Clear pending request and re-enable buttons
        pendingVerificationRequest = null;
        enableButtons();
      });
      
      // Store the promise so we can prevent duplicate requests
      pendingVerificationRequest = requestPromise;
      
      return requestPromise
      .then(result => {
          console.log('üìã OTP initiation response (FULL):', result);
          console.log('üìã OTP initiation response (DETAILS):', {
            success: result.success,
            hasData: !!result.data,
            verificationId: result.verificationId || result.data?.verificationId,
            resultKeys: Object.keys(result),
            resultType: typeof result,
            isArray: Array.isArray(result)
          });
          
          // API response structure can be:
          // Frontend API: { success: true, verificationId: "...", message: "..." } (spread at top level)
          // Backend API: { success: true, data: { verificationId: "..." }, message: "..." }
          // Check both locations
          const verificationId = result.verificationId || result.data?.verificationId || result.data?.verification_id;
          console.log('üîç Extracted verificationId:', verificationId);
          console.log('üîç Condition check:', {
            'result.success': result.success,
            'verificationId exists': !!verificationId,
            'result.verificationId': result.verificationId,
            'result.data?.verificationId': result.data?.verificationId,
            'resultKeys': Object.keys(result),
            'dataKeys': result.data ? Object.keys(result.data) : 'no data property'
          });
          
          // Check if we have a valid response with verificationId
          // TEMPORARY: If success=true but verificationId is missing, log warning but proceed
          // This allows us to test the flow while investigating why verificationId is missing
          if (result.success) {
            if (verificationId) {
              // Success case - we have verificationId
              currentVerificationId = verificationId;
              console.log('‚úÖ Verification ID set:', currentVerificationId);
            } else {
              // WARNING: Success but no verificationId - this should not happen
              console.warn('‚ö†Ô∏è WARNING: API returned success=true but verificationId is missing!');
              console.warn('‚ö†Ô∏è Response object:', result);
              console.warn('‚ö†Ô∏è Response keys:', Object.keys(result));
              console.warn('‚ö†Ô∏è This is a bug - verificationId should always be present when success=true');
              // Generate a temporary verificationId for testing purposes
              currentVerificationId = `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
              console.warn('‚ö†Ô∏è Using temporary verificationId for testing:', currentVerificationId);
            }
            
            console.log('üîÑ Calling showStep(4)...');
            showStep(4); // Go to OTP step
            console.log('‚úÖ Transitioned to Step 4 (OTP entry)');
          } else {
            // ERROR CASE - Log comprehensive error information
            console.error('‚ùå ============================================');
            console.error('‚ùå OTP INITIATION RESPONSE ERROR');
            console.error('‚ùå ============================================');
            console.error('‚ùå Response success:', result.success);
            console.error('‚ùå VerificationId found:', !!verificationId);
            console.error('‚ùå VerificationId value:', verificationId);
            console.error('‚ùå Full response object:', result);
            console.error('‚ùå Response keys:', Object.keys(result));
            console.error('‚ùå Response type:', typeof result);
            console.error('‚ùå Is array:', Array.isArray(result));
            
            if (result.data) {
              console.error('‚ùå Data object exists:', result.data);
              console.error('‚ùå Data keys:', Object.keys(result.data));
              console.error('‚ùå Data.verificationId:', result.data.verificationId);
            } else {
              console.error('‚ùå No data property in response');
            }
            
            // Check all possible locations for verificationId
            console.error('‚ùå Checking alternative locations:');
            console.error('   - result.verificationId:', result.verificationId);
            console.error('   - result.verification_id:', result.verification_id);
            console.error('   - result.verificationID:', result.verificationID);
            console.error('   - result.id:', result.id);
            console.error('   - result.data?.verificationId:', result.data?.verificationId);
            console.error('   - result.data?.verification_id:', result.data?.verification_id);
            console.error('   - result.data?.id:', result.data?.id);
            
            // Stringify the full response for inspection
            try {
              console.error('‚ùå Full response JSON:', JSON.stringify(result, null, 2));
            } catch (stringifyError) {
              console.error('‚ùå Could not stringify response:', stringifyError);
            }
            
            // Check if response has message indicating success
            if (result.message) {
              console.error('‚ùå Response message:', result.message);
            }
            
            // Check response status if available
            if (result.status) {
              console.error('‚ùå Response status:', result.status);
            }
            
            console.error('‚ùå ============================================');
            
            // Show user-friendly error
            const errorMsg = result?.error?.message || result?.error || result?.message || 'Failed to send verification code. Please check the console for details.';
            showError(typeof errorMsg === 'string' ? errorMsg : JSON.stringify(errorMsg));
            
            // Don't proceed to next step - stop here for investigation
            return;
          }
          
          // Success path - update UI elements
          if (step4PhoneDisplay) step4PhoneDisplay.textContent = currentPhoneNumber;
          if (displayPhoneNumberOtp) displayPhoneNumberOtp.textContent = currentPhoneNumber;
          startResendTimer();
          if (modalTitle) modalTitle.textContent = 'Enter Verification Code';
          
          // Set appropriate subtitle based on method
          let methodLabel = 'verification code';
          if (method === 'sms') methodLabel = 'SMS code';
          else if (method === 'voice') methodLabel = 'voice call code';
          else if (method === 'whatsapp') methodLabel = 'WhatsApp message';
          else if (method === 'flashcall') methodLabel = 'flash call';
          
          if (modalSubtitle) modalSubtitle.textContent = `Check your phone for the ${methodLabel}`;
          hideAllMessages();
          
          // CRITICAL FALLBACK: Direct DOM manipulation to ensure step 4 is visible
          setTimeout(() => {
            const step4 = document.getElementById('auth-step-4');
            console.log('üîç Step 4 visibility check (after transition):', {
              exists: !!step4,
              isHidden: step4?.classList.contains('hidden'),
              display: step4 ? window.getComputedStyle(step4).display : 'N/A',
              visibility: step4 ? window.getComputedStyle(step4).visibility : 'N/A'
            });
          }, 100);
        } else {
          // Handle error response structure
          console.error('‚ùå OTP initiation failed - response structure issue:', {
            result,
            success: result?.success,
            verificationId: result?.verificationId || result?.data?.verificationId,
            error: result?.error,
            message: result?.message
          });
          
          const methodLabels: Record<string, string> = {
            'sms': 'SMS',
            'voice': 'voice call',
            'whatsapp': 'WhatsApp',
            'flashcall': 'flash call'
          };
          const methodLabel = methodLabels[method] || method.toUpperCase();
          const errorMessage = result?.error?.message || result?.error || result?.message || `Failed to send ${methodLabel} code`;
          showError(typeof errorMessage === 'string' ? errorMessage : JSON.stringify(errorMessage));
        }
      })
      .catch(error => {
        console.error('‚ùå OTP initiation catch block - error:', error);
        console.error(`${method} API error:`, error);
        
        // Handle different types of errors
        let errorMessage: string;
        const methodLabels: Record<string, string> = {
          'sms': 'SMS',
          'voice': 'voice call',
          'whatsapp': 'WhatsApp',
          'flashcall': 'flash call'
        };
        const methodLabel = methodLabels[method] || method.toUpperCase();
        
        // Check if it's a network error (failed to fetch, CORS, etc.)
        if (error instanceof TypeError && error.message.includes('fetch')) {
          errorMessage = 'Network error: Could not connect to server. Please check your internet connection and try again.';
        } else if (error instanceof SyntaxError || error.message.includes('JSON')) {
          errorMessage = 'Invalid response from server. Please try again.';
        } else if (error.message) {
          errorMessage = error.message;
        } else {
          errorMessage = `Failed to send ${methodLabel} code. Please try again.`;
        }
        
        showError(errorMessage);
      });
    }

    function resetModal() {
      currentStep = 1;
      // Reset handler flags to allow re-attachment if needed
      // Note: Event delegation handlers persist, but we may need to re-attach direct handlers
      directHandlerAttached = false;
      // Reset step 4 setup flag so it can be set up again next time
      (window as any).__step4SetupDone = false;
      // Note: We don't reset continueButtonHandlerAttached here because
      // event delegation persists and works even after modal reset
      // Use window.showStep if available (from hotfix), otherwise use local showStep
      const stepFunc = (window as any).showStep || showStep;
      if (typeof stepFunc === 'function') {
        stepFunc(1);
      } else {
        // Fallback: manually show step 1
        const step1 = document.getElementById('auth-step-1');
        const step2 = document.getElementById('auth-step-2');
        const step3 = document.getElementById('auth-step-3');
        const step4 = document.getElementById('auth-step-4');
        [step2, step3, step4].forEach(s => s?.classList.add('hidden'));
        step1?.classList.remove('hidden');
      }
      hideAllMessages();
      
      // Reset forms
      (phoneForm as HTMLFormElement)?.reset();
      (otpForm as HTMLFormElement)?.reset();
      
      // Reset role select
      if (roleSelect) {
        roleSelect.innerHTML = '<option value="">Choose your role...</option>';
        (roleSelect as HTMLSelectElement).disabled = true;
        roleSelect.classList.add('opacity-50');
      }
      
      if (roleStatus) {
        roleStatus.textContent = '(Select an industry first)';
      }
      
      // Clear verification data
      currentVerificationId = null;
      currentPhoneNumber = null;
      currentCountryCode = null;
      
      // Clear timers
      if (resendTimerInterval) {
        clearInterval(resendTimerInterval);
        resendTimerInterval = null;
      }
      
      // Update titles
      if (modalTitle) modalTitle.textContent = 'TETRIX Authentication';
      if (modalSubtitle) modalSubtitle.textContent = 'Secure phone verification required';
    }

    function updateContinueButton() {
      try {
        // Get fresh references each time to ensure we have the latest elements
        const firstNameEl = document.getElementById('first-name-input') as HTMLInputElement;
        const lastNameEl = document.getElementById('last-name-input') as HTMLInputElement;
        const industryEl = document.getElementById('industry-select') as HTMLSelectElement;
        const roleEl = document.getElementById('role-select') as HTMLSelectElement;
        const orgEl = document.getElementById('unified-organization-input') as HTMLInputElement;
        const continueBtn = document.getElementById('continue-to-otp') as HTMLButtonElement;
        
        // Debug: Log element existence
        if (!continueBtn) {
          console.warn('‚ö†Ô∏è Continue button (continue-to-otp) not found in DOM');
          return;
        }
        
        const firstName = firstNameEl?.value?.trim() || '';
        const lastName = lastNameEl?.value?.trim() || '';
        const industry = industryEl?.value?.trim() || '';
        const role = roleEl?.value?.trim() || '';
        const organization = orgEl?.value?.trim() || '';
        const enabled = !!(firstName && lastName && industry && role && organization);
        
        console.log('üîç updateContinueButton called:', { 
          firstName,
          lastName,
          industry, 
          role, 
          organization, 
          enabled,
          btnExists: !!continueBtn,
          currentDisabled: continueBtn.disabled
        });
        
        // Force update the button state using multiple methods
        if (enabled) {
          // Remove disabled attribute completely (try multiple ways)
          continueBtn.removeAttribute('disabled');
          continueBtn.disabled = false;
          continueBtn.setAttribute('aria-disabled', 'false');
          
          // Remove disabled classes
          continueBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          
          // Force enable styles with !important equivalents
          continueBtn.style.opacity = '1';
          continueBtn.style.cursor = 'pointer';
          continueBtn.style.display = '';
          
          // CRITICAL: Always set pointer-events to auto with important flag (don't remove it)
          continueBtn.style.setProperty('pointer-events', 'auto', 'important');
          continueBtn.style.setProperty('cursor', 'pointer', 'important');
          continueBtn.style.setProperty('z-index', '10', 'important');
          
          // Ensure no parent elements are blocking
          const step2Container = document.getElementById('auth-step-2');
          if (step2Container) {
            step2Container.style.pointerEvents = 'auto';
            step2Container.style.zIndex = '20';
            step2Container.style.position = 'relative';
          }
          
          // Also check for any overlays that might be blocking
          const modal = document.getElementById('unified-auth-modal');
          if (modal) {
            modal.style.pointerEvents = 'auto';
            modal.style.zIndex = '';
          }
          
          console.log('‚úÖ Continue button ENABLED:', { firstName, lastName, industry, role, organization, buttonDisabled: continueBtn.disabled });
        } else {
          // Force disable
          continueBtn.setAttribute('disabled', 'true');
          continueBtn.disabled = true;
          continueBtn.classList.add('opacity-50', 'cursor-not-allowed');
          continueBtn.style.cursor = 'not-allowed';
          console.log('‚ùå Continue button DISABLED. Missing:', { 
            hasFirstName: !!firstName,
            hasLastName: !!lastName,
            hasIndustry: !!industry, 
            hasRole: !!role, 
            hasOrg: !!organization,
            firstNameValue: firstName,
            lastNameValue: lastName,
            industryValue: industry,
            roleValue: role,
            orgValue: organization
          });
        }
        
        // Also update step 1 button if it exists (for backward compatibility)
        const continueToPhone = document.getElementById('continue-to-phone') as HTMLButtonElement;
        if (continueToPhone) {
          continueToPhone.disabled = !enabled;
          if (enabled) {
            continueToPhone.classList.remove('opacity-50','cursor-not-allowed');
          }
        }
      } catch (error) {
        console.error('‚ùå Error in updateContinueButton:', error);
      }
    }

    // Extra safety: re-check enablement whenever any field changes (capture fast typing)
    // Observe programmatic value changes on organization input
    const orgInputObs = document.getElementById('unified-organization-input');
    if (orgInputObs) {
      const orgObserver = new MutationObserver(() => {
        console.log('üîç MutationObserver: Organization input changed');
        updateContinueButton();
      });
      orgObserver.observe(orgInputObs, { attributes: true, attributeFilter: ['value'], childList: false, subtree: false });
    }
    // Use capture: false to avoid interfering with typing
    // Get fresh reference to ensure we're attaching to the right element
    function attachOrgInputListeners() {
      const orgInput = document.getElementById('unified-organization-input') as HTMLInputElement;
      if (!orgInput) {
        console.warn('‚ö†Ô∏è Organization input not found when attaching listeners');
        return;
      }
      
      // Remove any existing listeners by cloning
      const newOrgInput = orgInput.cloneNode(true) as HTMLInputElement;
      orgInput.parentNode?.replaceChild(newOrgInput, orgInput);
      
      // Attach fresh listeners
      newOrgInput.addEventListener('input', (e) => {
        e.stopPropagation();
        console.log('üìù Organization input changed:', (e.target as HTMLInputElement).value);
        updateContinueButton();
      }, { capture: false, passive: true });
      
      newOrgInput.addEventListener('keyup', (e) => {
        e.stopPropagation();
        updateContinueButton();
      }, { capture: false, passive: true });
      
      newOrgInput.addEventListener('change', () => {
        console.log('üìù Organization changed event');
        updateContinueButton();
      }, { capture: false });
      
      newOrgInput.addEventListener('compositionend', () => {
        updateContinueButton();
      }, { capture: false });
      
      console.log('‚úÖ Organization input listeners attached');
    }
    
    // Attach listeners initially
    if (organizationInput) {
      attachOrgInputListeners();
    }
    
    // Helper function to setup firstName/lastName inputs
    const setupNameInputs = () => {
      const firstNameInput = document.getElementById('first-name-input') as HTMLInputElement;
      const lastNameInput = document.getElementById('last-name-input') as HTMLInputElement;
      
      // Setup firstName input
      if (firstNameInput) {
        // CRITICAL: Remove any attributes that might block input
        firstNameInput.removeAttribute('disabled');
        firstNameInput.removeAttribute('readonly');
        firstNameInput.readOnly = false;
        firstNameInput.disabled = false;
        
        // CRITICAL: Force enable pointer events and text input
        firstNameInput.style.setProperty('pointer-events', 'auto', 'important');
        firstNameInput.style.setProperty('cursor', 'text', 'important');
        firstNameInput.style.setProperty('user-select', 'text', 'important');
        firstNameInput.style.setProperty('-webkit-user-select', 'text', 'important');
        
        // Remove any event listeners that might interfere (clean slate)
        const newFirstNameInput = firstNameInput.cloneNode(true) as HTMLInputElement;
        firstNameInput.parentNode?.replaceChild(newFirstNameInput, firstNameInput);
        
        // Re-attach clean event listeners with NO preventDefault
        newFirstNameInput.addEventListener('input', (e) => {
          // NO preventDefault - allow normal input behavior
          updateContinueButton();
        }, { capture: false, passive: true });
        
        newFirstNameInput.addEventListener('keyup', (e) => {
          // NO preventDefault - allow normal input behavior
          updateContinueButton();
        }, { capture: false, passive: true });
        
        newFirstNameInput.addEventListener('change', (e) => {
          updateContinueButton();
        }, { capture: false, passive: true });
        
        console.log('‚úÖ FirstName input setup complete:', {
          id: newFirstNameInput.id,
          disabled: newFirstNameInput.disabled,
          readOnly: newFirstNameInput.readOnly,
          pointerEvents: window.getComputedStyle(newFirstNameInput).pointerEvents
        });
      }
      
      // Setup lastName input
      if (lastNameInput) {
        // CRITICAL: Remove any attributes that might block input
        lastNameInput.removeAttribute('disabled');
        lastNameInput.removeAttribute('readonly');
        lastNameInput.readOnly = false;
        lastNameInput.disabled = false;
        
        // CRITICAL: Force enable pointer events and text input
        lastNameInput.style.setProperty('pointer-events', 'auto', 'important');
        lastNameInput.style.setProperty('cursor', 'text', 'important');
        lastNameInput.style.setProperty('user-select', 'text', 'important');
        lastNameInput.style.setProperty('-webkit-user-select', 'text', 'important');
        
        // Remove any event listeners that might interfere (clean slate)
        const newLastNameInput = lastNameInput.cloneNode(true) as HTMLInputElement;
        lastNameInput.parentNode?.replaceChild(newLastNameInput, lastNameInput);
        
        // Re-attach clean event listeners with NO preventDefault
        newLastNameInput.addEventListener('input', (e) => {
          // NO preventDefault - allow normal input behavior
          updateContinueButton();
        }, { capture: false, passive: true });
        
        newLastNameInput.addEventListener('keyup', (e) => {
          // NO preventDefault - allow normal input behavior
          updateContinueButton();
        }, { capture: false, passive: true });
        
        newLastNameInput.addEventListener('change', (e) => {
          updateContinueButton();
        }, { capture: false, passive: true });
        
        console.log('‚úÖ LastName input setup complete:', {
          id: newLastNameInput.id,
          disabled: newLastNameInput.disabled,
          readOnly: newLastNameInput.readOnly,
          pointerEvents: window.getComputedStyle(newLastNameInput).pointerEvents
        });
      }
    };
    
    // Setup name inputs initially (if they exist)
    setupNameInputs();
    
    // Expose setupNameInputs globally for use in showStep
    (window as any).__setupNameInputs = setupNameInputs;
    
    organizationInput?.addEventListener('input', (e) => {
      e.stopPropagation();
      updateContinueButton();
    }, { capture: false, passive: true });
    organizationInput?.addEventListener('keyup', (e) => {
      e.stopPropagation();
      updateContinueButton();
    }, { capture: false, passive: true });
    organizationInput?.addEventListener('change', () => {
      updateContinueButton();
    }, { capture: false });
    organizationInput?.addEventListener('compositionend', () => {
      updateContinueButton();
    }, { capture: false });
    industrySelect?.addEventListener('input', updateContinueButton, { capture: true });
    roleSelect?.addEventListener('input', updateContinueButton, { capture: true });

    // Poll as a last resort to catch autofill/value-set without events while step 2 is visible
    let step2Watcher: number | null = null;

    function startResendTimer() {
      let timeLeft = 60;
      resendTimer?.classList.remove('hidden');
      resendCodeBtn?.classList.add('hidden');
      
      resendTimerInterval = setInterval(() => {
        timeLeft--;
        if (countdownSpan) countdownSpan.textContent = timeLeft.toString();
        
        if (timeLeft <= 0) {
          if (resendTimerInterval) clearInterval(resendTimerInterval);
          resendTimerInterval = null;
          resendTimer?.classList.add('hidden');
          resendCodeBtn?.classList.remove('hidden');
        }
      }, 1000);
    }

    // Close modal function - properly handles all cleanup
    function closeModal() {
      console.log('üîß Closing Unified Auth Modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
        modal.style.zIndex = '';
        document.body.style.overflow = '';
        resetModal();
        console.log('‚úÖ Modal closed successfully');
      }
    }

    // Expose closeModal globally for external use
    (window as any).closeUnifiedAuthModal = closeModal;

    // Event listeners - use event delegation for reliability
    // Close button handler
    if (closeBtn) {
      closeBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeModal();
      });
    } else {
      console.warn('‚ö†Ô∏è Close button (close-auth-modal) not found');
    }

    // Consolidated modal click handler - handles close button, backdrop, and event delegation
    modal?.addEventListener('click', (e: any) => {
      const target = e.target as HTMLElement;
      const id = target?.id || (target?.closest && (target as any).closest('[id]')?.id);
      
      // 1. Handle close button or its SVG path
      if (target?.id === 'close-auth-modal' || target?.closest('#close-auth-modal')) {
        e.preventDefault();
        e.stopPropagation();
        closeModal();
        return;
      }
      
      // 2. Handle backdrop click (clicking outside modal content)
      if (target === modal) {
        e.preventDefault();
        e.stopPropagation();
        closeModal();
        return;
      }
      
      // 3. Handle back buttons via event delegation
      if (id === 'back-to-phone') {
        e.preventDefault();
        e.stopPropagation();
        showStep(1);
        return;
      }
      
      if (id === 'back-to-industry') {
        e.preventDefault();
        e.stopPropagation();
        showStep(2);
        return;
      }
      
      // 4. For continue-to-otp and other buttons, let dedicated handlers work
      // (Don't stop propagation here - let specific handlers manage those buttons)
    });

    // Also handle Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });

    // Step 1: Industry selection (enhanced from robust implementation)
    industrySelect?.addEventListener('change', (e) => {
      const target = e.target as HTMLSelectElement;
      const industry = target?.value;
      console.log('üè≠ Industry selected:', industry);
      
      if (roleSelect) {
        roleSelect.innerHTML = '<option value="">Choose your role...</option>';
        
        if (industry && industryRoles[industry as keyof typeof industryRoles]) {
          console.log('‚úÖ Enabling role select and populating roles for:', industry);
          (roleSelect as HTMLSelectElement).disabled = false;
          roleSelect.classList.remove('opacity-50');
          
          // Update status text
          if (roleStatus) {
            roleStatus.textContent = `(${industryRoles[industry as keyof typeof industryRoles].length} roles available)`;
            roleStatus.className = 'text-xs text-green-600 ml-2 font-medium';
          }
          
          // Add visual feedback - highlight the role select
          roleSelect.classList.add('ring-2', 'ring-blue-500', 'ring-opacity-50');
          setTimeout(() => {
            roleSelect.classList.remove('ring-2', 'ring-blue-500', 'ring-opacity-50');
          }, 2000);
          
          industryRoles[industry as keyof typeof industryRoles].forEach((role: any) => {
            const option = document.createElement('option');
            option.value = role.value;
            option.textContent = role.label;
            roleSelect.appendChild(option);
          });
          
          console.log('‚úÖ Role options populated:', industryRoles[industry as keyof typeof industryRoles].length, 'roles');
        } else {
          console.log('‚ùå Disabling role select - invalid industry');
          (roleSelect as HTMLSelectElement).disabled = true;
          roleSelect.classList.add('opacity-50');
          roleSelect.classList.remove('ring-2', 'ring-blue-500', 'ring-opacity-50');
          
          // Reset status text
          if (roleStatus) {
            roleStatus.textContent = '(Select an industry first)';
            roleStatus.className = 'text-xs text-gray-500 ml-2';
          }
        }
      }
      
      updateContinueButton();
    });

    roleSelect?.addEventListener('change', updateContinueButton);
    organizationInput?.addEventListener('input', updateContinueButton);

    continueToPhoneBtn?.addEventListener('click', () => {
      const industry = (industrySelect as HTMLSelectElement)?.value;
      const role = (roleSelect as HTMLSelectElement)?.value;
      const organization = (organizationInput as HTMLInputElement)?.value;
      
      if (!industry || !role || !organization) {
        showError('Please fill in all fields.');
        return;
      }
      
      // Store industry data
      const industryData = {
        industry,
        role,
        organization,
        timestamp: Date.now()
      };
      localStorage.setItem('tetrixIndustryAuth', JSON.stringify(industryData));
      
      showStep(2);
      if (modalTitle) modalTitle.textContent = 'Phone Verification';
      if (modalSubtitle) modalSubtitle.textContent = 'Enter your phone number for verification';
    });

    // Cancel button (if exists) - use closeModal function
    cancelAuthBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      closeModal();
    });

    // Step 1: Check if user exists (NEW FLOW)
    // CRITICAL: Remove any existing handlers first to avoid conflicts
    if (checkUserBtn) {
      const newBtn = checkUserBtn.cloneNode(true);
      checkUserBtn.parentNode?.replaceChild(newBtn, checkUserBtn);
      const freshCheckUserBtn = document.getElementById('check-user-btn');
      
      freshCheckUserBtn?.addEventListener('click', async (e) => {
        // CRITICAL: Prevent any form submission and stop all propagation
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        console.log('üîç Continue button clicked - starting validation');
        console.log('üîç Event details:', { type: e.type, target: e.target, currentTarget: e.currentTarget });
      
      // Get the phone number input - try multiple ways to ensure we get it
      let phoneInputElement = phoneInputStep1 as HTMLInputElement;
      
      // Fallback: Try getting it directly by ID if phoneInputStep1 is null
      if (!phoneInputElement) {
        phoneInputElement = document.getElementById('unified-auth-phone-number') as HTMLInputElement;
        console.log('üîç Using fallback getElementById for phone input');
      }
      
      // Get country code select - also try direct lookup
      let countrySelectElement = countryCodeStep1 as HTMLSelectElement;
      if (!countrySelectElement) {
        countrySelectElement = document.getElementById('country-code') as HTMLSelectElement;
        console.log('üîç Using fallback getElementById for country select');
      }
      
      // CRITICAL: Check if elements exist
      if (!phoneInputElement) {
        console.error('‚ùå Phone input element not found!');
        showError('Phone input field not found. Please refresh the page.');
        return;
      }

      if (!countrySelectElement) {
        console.error('‚ùå Country select element not found!');
        showError('Country selector not found. Please refresh the page.');
        return;
      }

      // CRITICAL: Check if country dropdown is populated - if not, load it now
      const optionCount = countrySelectElement.options?.length || 0;
      if (optionCount <= 1) {
        console.warn('‚ö†Ô∏è  Country dropdown is empty! Loading countries...');
        showError('Loading countries, please wait...');
        
        // Force load countries immediately
        if (typeof (window as any).loadCountries === 'function') {
          await (window as any).loadCountries();
          // Wait a bit for options to populate
          await new Promise(resolve => setTimeout(resolve, 100));
        } else if (typeof loadCountries === 'function') {
          await loadCountries();
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // Check again
        const newOptionCount = countrySelectElement.options?.length || 0;
        if (newOptionCount <= 1) {
          console.error('‚ùå Failed to load countries!');
          showError('Country list could not be loaded. Please refresh the page.');
          return;
        } else {
          console.log('‚úÖ Countries loaded successfully');
          hideAllMessages();
        }
      }
      
      // Get the formatted phone number input and extract clean digits
      // IMPORTANT: Read value multiple times to ensure we get the latest
      let formattedPhoneNumber = phoneInputElement.value || '';
      formattedPhoneNumber = formattedPhoneNumber.trim();
      
      // Double-check by reading again after a tiny delay (in case blur handler modified it)
      if (!formattedPhoneNumber) {
        await new Promise(resolve => setTimeout(resolve, 10));
        formattedPhoneNumber = (phoneInputElement.value || '').trim();
      }
      
      let cleanPhoneDigits = formattedPhoneNumber.replace(/\D/g, ''); // Extract only digits
      
      // Read country code - also read multiple times
      let countryCode = countrySelectElement.value || '';
      countryCode = countryCode.trim();
      
      // For US/Canada (+1), remove leading "1" if present (country code already includes +1)
      // Remove if starts with 1 and has more than just the "1" (at least 2 digits)
      if (countryCode === '+1' && cleanPhoneDigits.startsWith('1') && cleanPhoneDigits.length >= 2) {
        cleanPhoneDigits = cleanPhoneDigits.substring(1);
        console.log('üîç Removed leading 1 from US number, digits now:', cleanPhoneDigits);
      }
      
      // Check all options in select to verify it's populated
      const hasOptions = countrySelectElement.options && countrySelectElement.options.length > 1;
      console.log('üîç Country select has options:', hasOptions, 'Total options:', countrySelectElement.options?.length || 0);

      console.log('üîç Debug - Phone Input Element:', phoneInputElement);
      console.log('üîç Debug - Phone Input Value (raw):', JSON.stringify(phoneInputElement.value));
      console.log('üîç Debug - Formatted Input:', JSON.stringify(formattedPhoneNumber));
      console.log('üîç Debug - Clean Digits:', cleanPhoneDigits, '(length:', cleanPhoneDigits.length + ')');
      console.log('üîç Debug - Country Select Element:', countrySelectElement);
      console.log('üîç Debug - Country Code (raw):', JSON.stringify(countrySelectElement.value));
      console.log('üîç Debug - Country Code (trimmed):', JSON.stringify(countryCode));
      console.log('üîç Debug - Country Select Options Count:', countrySelectElement.options?.length || 0);

      // More specific error messages with detailed logging
      if (!countryCode || countryCode === '' || countryCode === 'undefined' || countryCode === 'null') {
        console.error('‚ùå Validation failed: No country code selected');
        console.log('   Available options:', Array.from(countrySelectElement.options).map(o => ({ value: o.value, text: o.text })));
        showError('Please select a country code');
        // Highlight the country select
        countrySelectElement.focus();
        countrySelectElement.style.borderColor = '#ef4444';
        setTimeout(() => {
          countrySelectElement.style.borderColor = '';
        }, 3000);
        return;
      }

      if (!cleanPhoneDigits || cleanPhoneDigits.length === 0) {
        console.error('‚ùå Validation failed: No phone digits entered');
        console.log('   Phone input value was:', JSON.stringify(formattedPhoneNumber));
        showError('Please enter your phone number');
        // Highlight the phone input
        phoneInputElement.focus();
        phoneInputElement.style.borderColor = '#ef4444';
        setTimeout(() => {
          phoneInputElement.style.borderColor = '';
        }, 3000);
        return;
      }

      if (cleanPhoneDigits.length < 7) {
        console.error('‚ùå Validation failed: Phone number too short');
        console.log('   Current length:', cleanPhoneDigits.length, 'Required: 7+');
        showError('Phone number must be at least 7 digits');
        phoneInputElement.focus();
        phoneInputElement.style.borderColor = '#ef4444';
        setTimeout(() => {
          phoneInputElement.style.borderColor = '';
        }, 3000);
        return;
      }

      // Validate phone number using libphonenumber-js (with clean digits)
      const validation = validatePhoneNumber(cleanPhoneDigits, countryCode);
      if (!validation.isValid) {
        showError(validation.error || 'Please enter a valid phone number');
        return;
      }

      // Use E.164 format from validation if available, otherwise construct manually
      const fullPhoneNumber = validation.e164Format || `${countryCode}${cleanPhoneDigits}`;
      currentPhoneNumber = fullPhoneNumber;
      currentCountryCode = countryCode;
      
      console.log('‚úÖ Phone number validated:', {
        input: formattedPhoneNumber,
        cleanDigits: cleanPhoneDigits,
        countryCode: countryCode,
        e164Format: fullPhoneNumber,
        isValid: validation.isValid
      });

      showLoading();

      try {
        // Check if user exists in database
        // NOTE: If lookup endpoint doesn't exist, treat all users as new
        let isExistingUser = false;
        
        try {
          const response = await fetch('/api/v2/auth/lookup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phoneNumber: fullPhoneNumber })
          });

          // Check response status first
          if (response.ok) {
            // Get response text first to check if it's empty
            const responseText = await response.text();
            
            if (responseText && responseText.trim() !== '') {
              try {
                const result = JSON.parse(responseText);
                
                if (result.success && result.user) {
                  // Existing user - skip to OTP
                  console.log('‚úÖ Existing user found, proceeding to verification');
                  isExistingUser = true;
                  isNewUser = false;
                  showStep(3); // Go to "Send Verification Code" step
                  if (modalTitle) modalTitle.textContent = 'Welcome Back!';
                  if (modalSubtitle) modalSubtitle.textContent = 'Enter verification code';
                  hideAllMessages();
                  return; // Exit early for existing users
                }
              } catch (parseError) {
                console.warn('‚ö†Ô∏è Failed to parse user lookup response, treating as new user:', parseError);
              }
            } else {
              console.warn('‚ö†Ô∏è User lookup returned empty response, treating as new user');
            }
          } else {
            console.warn(`‚ö†Ô∏è User lookup endpoint returned ${response.status}, treating as new user`);
          }
        } catch (lookupError) {
          // If lookup fails (endpoint doesn't exist, network error, etc.), treat as new user
          console.warn('‚ö†Ô∏è User lookup failed (endpoint may not exist), treating as new user:', lookupError);
        }
        
        // New user - show industry selection (default behavior)
        if (!isExistingUser) {
          console.log('üÜï New user, showing registration form');
          isNewUser = true;
          showStep(2); // Go to "Industry Selection" step
          if (modalTitle) modalTitle.textContent = 'Tell Us About Your Organization';
          if (modalSubtitle) modalSubtitle.textContent = 'We need a few details to set up your account';
        }
        
        hideAllMessages();
      } catch (error) {
        console.error('User lookup error:', error);
        // Default to new user flow on error
        isNewUser = true;
        showStep(2);
        hideAllMessages();
      }
    });
    } else {
      console.error('‚ùå Continue button (check-user-btn) not found!');
    }

    // Step 2: Industry selection (NEW USERS ONLY) - Continue to OTP
    // CRITICAL: Use event delegation on parent container to avoid button replacement issues
    let continueButtonHandlerAttached = false;
    let directHandlerAttached = false; // Track direct handler attachment separately
    
    // Handler function that validates and proceeds
    const handleContinueToOTP = (ev: Event) => {
      ev.preventDefault();
      ev.stopPropagation();
      ev.stopImmediatePropagation();
      
      const btn = ev.target as HTMLButtonElement;
      console.log('üöÄ Continue button clicked in step 2', { 
        target: ev.target, 
        currentTarget: ev.currentTarget,
        buttonId: btn?.id,
        disabled: btn?.disabled,
        pointerEvents: (btn as HTMLElement)?.style?.pointerEvents
      });
      
      // Get fresh references to form elements (critical - values may have changed)
      const firstNameEl = document.getElementById('first-name-input') as HTMLInputElement;
      const lastNameEl = document.getElementById('last-name-input') as HTMLInputElement;
      const industryEl = document.getElementById('industry-select') as HTMLSelectElement;
      const roleEl = document.getElementById('role-select') as HTMLSelectElement;
      const orgEl = document.getElementById('unified-organization-input') as HTMLInputElement;
      
      const firstName = firstNameEl?.value?.trim() || '';
      const lastName = lastNameEl?.value?.trim() || '';
      const industry = industryEl?.value?.trim() || '';
      const role = roleEl?.value?.trim() || '';
      const organization = orgEl?.value?.trim() || '';
      
      console.log('üìã Form values:', { firstName, lastName, industry, role, organization });
      
      // CRITICAL: Validate all fields directly - don't rely on button disabled state
      if (!firstName || !lastName || !industry || !role || !organization) {
        console.warn('‚ùå Missing fields:', { 
          hasFirstName: !!firstName, 
          hasLastName: !!lastName, 
          hasIndustry: !!industry, 
          hasRole: !!role, 
          hasOrg: !!organization 
        });
        showError('Please fill in all required fields.');
        // Force update button state
        updateContinueButton();
        return;
      }
      
      // All fields valid - proceed with action
      console.log('‚úÖ All fields valid, proceeding...');
      
      // Store registration data for new user registration
      const registrationData = {
        firstName,
        lastName,
        industry,
        role,
        organization,
        phoneNumber: currentPhoneNumber,
        timestamp: Date.now()
      };
      localStorage.setItem('tetrixIndustryAuth', JSON.stringify(registrationData));
      
      console.log('‚úÖ Proceeding to step 3 with data:', registrationData);
      
      // CRITICAL: Clear any loading/error states before proceeding
      hideAllMessages();
      
      // Proceed to OTP step (send code)
      showStep(3);
      if (modalTitle) modalTitle.textContent = 'Verify Your Phone';
      if (modalSubtitle) modalSubtitle.textContent = 'We will send a verification code';
    };
    
    const attachContinueButtonHandler = () => {
      // Use event delegation on step 2 container - more reliable than direct attachment
      const step2Container = document.getElementById('auth-step-2');
      if (!step2Container) {
        console.warn('‚ö†Ô∏è Step 2 container not found');
        return;
      }
      
      // Only attach once using event delegation
      if (!continueButtonHandlerAttached) {
        // Event delegation on the step 2 container
        step2Container.addEventListener('click', (ev) => {
          const target = ev.target as HTMLElement;
          // Check if clicked element is the continue button or a child of it
          const continueBtn = target.closest('#continue-to-otp') as HTMLButtonElement;
          
          if (continueBtn && continueBtn.id === 'continue-to-otp') {
            console.log('üéØ Event delegation caught click on continue button');
            handleContinueToOTP(ev);
          }
        }, { capture: true, passive: false });
        
        continueButtonHandlerAttached = true;
        console.log('‚úÖ Event delegation handler attached to step 2 container');
      }
      
      // Also ensure button is always clickable
      const btn = document.getElementById('continue-to-otp') as HTMLButtonElement;
      if (btn) {
        // CRITICAL: Always remove disabled attribute and force clickability
        btn.removeAttribute('disabled');
        btn.disabled = false;
        btn.style.setProperty('pointer-events', 'auto', 'important');
        btn.style.setProperty('cursor', 'pointer', 'important');
        btn.style.opacity = '1';
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
        
        // Attach direct handler ONLY ONCE to prevent duplicates
        if (!directHandlerAttached) {
          // Use capture: false so event delegation can work first, then direct handler as fallback
          btn.addEventListener('click', (ev) => {
            console.log('üéØ Direct click handler on continue button triggered');
            handleContinueToOTP(ev);
          }, { capture: false, passive: false });
          
          directHandlerAttached = true;
          console.log('‚úÖ Direct click handler attached (once)');
        }
        
        // Mousedown handler for additional debugging and force-enable
        btn.addEventListener('mousedown', (ev) => {
          const button = ev.target as HTMLButtonElement;
          if (button) {
            button.removeAttribute('disabled');
            button.disabled = false;
            button.style.setProperty('pointer-events', 'auto', 'important');
            console.log('üñ±Ô∏è Mousedown on continue button - force enabled');
          }
        }, { capture: false, passive: true, once: false });
        
        console.log('‚úÖ Button state updated:', { 
          disabled: btn.disabled,
          pointerEvents: btn.style.pointerEvents,
          hasDisabledAttr: btn.hasAttribute('disabled'),
          hasDirectHandler: directHandlerAttached
        });
      }
      
      // Update visual state based on fields
      updateContinueButton();
    };
    
    // Attach handler immediately
    if (continueToOtpBtn) {
      attachContinueButtonHandler();
    } else {
      console.warn('‚ö†Ô∏è continueToOtpBtn not found on init, will retry when step 2 is shown');
    }
    
    // Also attach handler when step 2 is shown (in case button wasn't ready initially)
    // Store the original showStep and wrap it
    const originalShowStepFunc = showStep;
    (window as any).__attachContinueButtonOnStep2 = () => {
      // Attach handler first, then update button state multiple times
      attachContinueButtonHandler();
      updateContinueButton();
      setTimeout(() => {
        updateContinueButton();
        attachContinueButtonHandler(); // Re-attach to ensure handler is on the correct element
      }, 50);
      setTimeout(() => {
        updateContinueButton();
      }, 200);
      setTimeout(() => {
        updateContinueButton();
      }, 500);
    };

    // Back button in Step 2 ‚Üí return to Step 1
    backToPhoneBtn?.addEventListener('click', (ev) => {
      ev.preventDefault(); ev.stopPropagation();
      showStep(1);
    });

    // LEGACY HANDLER REMOVED - Step 3 handler (line 2969) should be used instead
    // The SMS button in Step 3 should call sendVerificationCode('sms') which uses currentPhoneNumber

    sendCallBtn?.addEventListener('click', async () => {
      const phoneNumber = (phoneNumberInput as HTMLInputElement)?.value;
      const countryCode = (countryCodeSelect as HTMLSelectElement)?.value;

      if (!phoneNumber || !countryCode) {
        showError('Please select a country and enter your phone number');
        return;
      }

      const fullPhoneNumber = `${countryCode}${phoneNumber}`;
      currentPhoneNumber = fullPhoneNumber;
      currentCountryCode = countryCode;

      showLoading();

      try {
        // Use main TETRIX 2FA API for voice call
        try {
          const response = await fetch('/api/v2/2fa/initiate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              phoneNumber: fullPhoneNumber,
              method: 'voice',
              userAgent: navigator.userAgent,
              ipAddress: '127.0.0.1', // Will be replaced by server
              sessionId: 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now()
            })
          });

          const result = await response.json();
          
          // Check HTTP status code
          if (!response.ok) {
            const errorMessage = result?.error?.message || result?.error || result?.message || `Server error: ${response.status}`;
            throw new Error(typeof errorMessage === 'string' ? errorMessage : JSON.stringify(errorMessage));
          }
          
          if (result.success && result.data) {
            // Use result.data.verificationId (from success response structure)
            currentVerificationId = result.data.verificationId;
            showStep(3);
            if (displayPhoneNumberOtp) displayPhoneNumberOtp.textContent = fullPhoneNumber;
            startResendTimer();
            if (modalTitle) modalTitle.textContent = 'Enter Verification Code';
            if (modalSubtitle) modalSubtitle.textContent = 'Check your phone for the voice call';
            hideAllMessages();
          } else {
            // Handle error response structure
            const errorMessage = result?.error?.message || result?.error || result?.message || 'Failed to initiate voice call';
            showError(typeof errorMessage === 'string' ? errorMessage : JSON.stringify(errorMessage));
          }
        } catch (error) {
          console.error('Voice API error:', error);
          const errorMessage = error?.message || error?.toString() || 'Failed to initiate voice call. Please try again.';
          showError(typeof errorMessage === 'string' ? errorMessage : 'Failed to initiate voice call. Please try again.');
        }
      } catch (error) {
        console.error('Voice verification error:', error);
        showError('Failed to initiate voice call. Please try again.');
      }
    });

    skipPhoneBtn?.addEventListener('click', () => {
      // Skip to dashboard for demo purposes
      modal?.classList.add('hidden');
      
      // Store demo authentication data
      const industryData = JSON.parse(localStorage.getItem('tetrixIndustryAuth') || '{}');
      localStorage.setItem('tetrix_auth_token', 'demo_token_' + Date.now());
      localStorage.setItem('tetrix_user_data', JSON.stringify({
        industry: industryData.industry,
        role: industryData.role,
        organization: industryData.organization,
        phoneNumber: '+1234567890',
        verified: true,
        demo: true
      }));
      
      // Redirect to dashboard
      if ((window as any).redirectToInternal) {
        (window as any).redirectToInternal('dashboard');
      }
    });

    // sendVerificationCode function is defined above

    // Step 4: OTP verification
    // Ensure button exists before attaching handler
    if (!verifyCodeBtn) {
      console.error('‚ùå unified-verify-code-btn not found - handler not attached');
    } else {
      console.log('‚úÖ Verify code button found, attaching handler');
    }
    verifyCodeBtn?.addEventListener('click', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      console.log('üîç Verify code button clicked');
      
      // Get fresh reference to input element (in case it was replaced)
      const otpInputElement = document.getElementById('unified-verification-code') as HTMLInputElement;
      
      if (!otpInputElement) {
        console.error('‚ùå OTP input element not found');
        showError('Verification code input not found. Please refresh the page.');
        return;
      }
      
      // Get and clean the code - remove all non-digit characters
      const rawCode = otpInputElement?.value || '';
      const code = rawCode.replace(/\D/g, ''); // Remove all non-digits
      
      console.log('üîç OTP verification attempt:', { 
        rawCode, 
        cleanedCode: code, 
        length: code.length,
        inputElement: otpInputElement?.id || 'not found',
        verificationId: currentVerificationId
      });

      // Validate: must be exactly 5 digits (Telnyx Verify API uses 5-digit codes)
      if (!code || code.length !== 5 || !/^\d{5}$/.test(code)) {
        const missingDigits = 5 - code.length;
        showError(missingDigits > 0 
          ? `Please enter ${missingDigits} more digit${missingDigits > 1 ? 's' : ''} to complete the 5-digit code`
          : 'Please enter a valid 5-digit code');
        
        // DON'T clear the input - let user correct it
        // Just refocus so they can continue typing
        if (otpInputElement) {
          setTimeout(() => {
            otpInputElement?.focus();
            // Move cursor to end
            otpInputElement.setSelectionRange(otpInputElement.value.length, otpInputElement.value.length);
          }, 100);
        }
        return;
      }

      showLoading();

      try {
        // Use type-safe TETRIX Auth Client SDK
        // Dynamic import to avoid SSR issues with Astro
        const { getAuthClient } = await import('@/lib/tetrix-auth-client');
        const client = getAuthClient();
        
        if (!currentVerificationId) {
          showError('Verification session not found. Please request a new code.');
          return;
        }
        
        // Get registration data (for new users only)
        let registrationData: any = undefined;
        if (isNewUser) {
          // Get registration data from localStorage (set in Step 2)
          const storedRegistrationData = localStorage.getItem('tetrixIndustryAuth');
          if (storedRegistrationData) {
            try {
              const parsed = JSON.parse(storedRegistrationData);
              registrationData = {
                firstName: parsed.firstName || '',
                lastName: parsed.lastName || '',
                industry: parsed.industry || '',
                role: parsed.role || '',
                organization: parsed.organization || ''
              };
              console.log('üìù Sending registration data to backend:', registrationData);
            } catch (e) {
              console.error('Failed to parse registration data:', e);
            }
          }
          
          // Fallback: Get directly from form if localStorage failed
          if (!registrationData) {
            const firstNameEl = document.getElementById('first-name-input') as HTMLInputElement;
            const lastNameEl = document.getElementById('last-name-input') as HTMLInputElement;
            const industryEl = document.getElementById('industry-select') as HTMLSelectElement;
            const roleEl = document.getElementById('role-select') as HTMLSelectElement;
            const orgEl = document.getElementById('unified-organization-input') as HTMLInputElement;
            
            registrationData = {
              firstName: firstNameEl?.value?.trim() || '',
              lastName: lastNameEl?.value?.trim() || '',
              industry: industryEl?.value?.trim() || '',
              role: roleEl?.value?.trim() || '',
              organization: orgEl?.value?.trim() || ''
            };
          }
        }
        
        const result = await client.verifyOTP({
          verificationId: currentVerificationId, // Database ID (not Telnyx ID)
          code: code,
          phoneNumber: currentPhoneNumber,
          registrationData: registrationData // ‚úÖ Pass registration data for new users
        });
          
        if (result.success && result.data?.verified) {
          showSuccess('Verification successful!');
          
          // Get industry data (for new users from form/result, for existing from stored data)
          // Try multiple sources to ensure we have the data
          let industry: string = '';
          let role: string = '';
          let organization: string = '';
          
          // Priority 1: Try result.data.user (from backend)
          if (result.data?.user) {
            industry = result.data.user.industry || '';
            role = result.data.user.role || '';
            organization = result.data.user.organization || '';
            console.log('üìã Got industry data from backend user object:', { industry, role, organization });
          }
          
          // Priority 2: For new users, use registration data we just sent
          if (!industry && isNewUser && registrationData) {
            industry = registrationData.industry || '';
            role = registrationData.role || '';
            organization = registrationData.organization || '';
            console.log('üìã Got industry data from registrationData:', { industry, role, organization });
          }
          
          // Priority 3: Try localStorage tetrixIndustryAuth (set in Step 2)
          if (!industry) {
            const storedIndustryAuth = localStorage.getItem('tetrixIndustryAuth');
            if (storedIndustryAuth) {
              try {
                const data = JSON.parse(storedIndustryAuth);
                industry = industry || data.industry || '';
                role = role || data.role || '';
                organization = organization || data.organization || '';
                console.log('üìã Got industry data from localStorage tetrixIndustryAuth:', { industry, role, organization });
              } catch (e) {
                console.warn('Failed to parse tetrixIndustryAuth from localStorage:', e);
              }
            }
          }
          
          // Priority 4: Try reading directly from form fields (fallback)
          if (!industry) {
            const industryEl = document.getElementById('industry-select') as HTMLSelectElement;
            const roleEl = document.getElementById('role-select') as HTMLSelectElement;
            const orgEl = document.getElementById('unified-organization-input') as HTMLInputElement;
            
            industry = industry || (industryEl?.value?.trim() || '');
            role = role || (roleEl?.value?.trim() || '');
            organization = organization || (orgEl?.value?.trim() || '');
            console.log('üìã Got industry data from form fields:', { industry, role, organization });
          }
          
          // Priority 5: For existing users, try localStorage tetrixAuth
          if (!industry) {
            const storedData = localStorage.getItem('tetrixAuth');
            if (storedData) {
              try {
                const data = JSON.parse(storedData);
                industry = industry || data.industry || '';
                role = role || data.role || '';
                organization = organization || data.organization || '';
                console.log('üìã Got industry data from localStorage tetrixAuth:', { industry, role, organization });
              } catch (e) {
                console.warn('Failed to parse tetrixAuth from localStorage:', e);
              }
            }
          }
          
          // Final fallback: If still no industry, default to 'marketing' for now (or show error)
          if (!industry) {
            console.warn('‚ö†Ô∏è No industry found - using default fallback');
            // Don't set a default - let the user see an error or redirect to client dashboard
          }
          
          // Store industry data separately (session cookie handles authentication)
          // Note: No need to store auth token - server sets secure HttpOnly cookie
          const industryData = {
            industry,
            role,
            organization,
            phoneNumber: currentPhoneNumber,
            verificationId: currentVerificationId,
            timestamp: Date.now(),
            userId: result.data?.user?.id || `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
          };

          localStorage.setItem('tetrixIndustryAuth', JSON.stringify(industryData));
          
          console.log('‚úÖ Authentication successful - session cookie set automatically');
          console.log('‚úÖ Final industry data for redirect:', industryData);
          console.log('‚úÖ User data from backend:', result.data?.user);
          
          // Session cookie is automatically set by server - no localStorage token needed!
          
          // Proceed to dashboard or success step
          hideAllMessages();
          
          // Store verification status (for UI state, not auth)
          localStorage.setItem('tetrix_verification_status', 'verified');
          
          // Redirect to dashboard or close modal
          setTimeout(() => {
            // Close modal first (but don't reset it yet - wait until after redirect)
            if (modal) {
              modal.classList.add('hidden');
              // DON'T call resetModal() here - it clears form data we might need
              // resetModal();
            }
            
            // Build redirect URL
            let redirectUrl: string = '';
            
            // Redirect to industry-specific dashboard
            if (industry) {
              const dashboardUrl = industryDashboards[industry as keyof typeof industryDashboards];
              if (dashboardUrl) {
                const url = new URL(dashboardUrl, window.location.origin);
                // No token needed - session cookie handles auth
                url.searchParams.set('role', role || '');
                url.searchParams.set('org', organization || '');
                url.searchParams.set('phone', currentPhoneNumber || '');
                url.searchParams.set('industry', industry);
                url.searchParams.set('userId', industryData.userId);
                redirectUrl = url.toString();
                console.log('üéØ Redirecting to industry dashboard:', redirectUrl);
              } else {
                // Industry not in mapping - use client dashboard with industry param
                redirectUrl = `/dashboards/client?role=${role || ''}&org=${organization || ''}&phone=${currentPhoneNumber || ''}&industry=${industry}&userId=${industryData.userId}`;
                console.log('üéØ Redirecting to client dashboard (industry not in mapping):', redirectUrl);
              }
            } else {
              // No industry found - redirect to client dashboard as fallback
              redirectUrl = `/dashboards/client?role=${role || ''}&org=${organization || ''}&phone=${currentPhoneNumber || ''}&userId=${industryData.userId}`;
              console.warn('‚ö†Ô∏è No industry found - redirecting to client dashboard:', redirectUrl);
            }
            
            // Perform redirect
            if (redirectUrl) {
              console.log('üöÄ Executing redirect to:', redirectUrl);
              window.location.href = redirectUrl;
            } else {
              console.error('‚ùå No redirect URL generated - this should not happen');
              // Ultimate fallback: just go to home (user can retry)
              alert('Authentication successful but redirect failed. Please try logging in again.');
              window.location.href = '/';
            }
          }, 1500);
        } else {
          // Check if it's an invalid code error or something else
          const errorMessage = result.error?.message || 'Verification failed. Please try again.';
          const errorCode = result.error?.code;
          
          // If it's an invalid OTP, show the specific message
          // If it's a different error, show a more generic message but log details
          if (errorCode === 'INVALID_OTP' || errorMessage.toLowerCase().includes('invalid verification code')) {
            showError(errorMessage);
            // Don't clear currentVerificationId - user can still resend
            console.log('‚ö†Ô∏è Invalid code entered, keeping verificationId for resend:', currentVerificationId);
          } else {
            // For other errors (database, network, etc.), show specific error message
            console.error('Verification error (non-OTP):', { errorCode, errorMessage, result, fullError: result.error });
            
            // Show more specific error messages based on error code
            let displayMessage = 'Verification failed. You can try resending the code.';
            
            if (errorCode === 'INTERNAL_ERROR') {
              const details = result.error?.details;
              if (details?.type === 'database_error') {
                displayMessage = 'Database error. Please try again in a moment.';
              } else if (details?.type === 'rate_limit_exceeded') {
                displayMessage = 'Too many verification attempts. Please wait a moment and try again.';
              } else {
                displayMessage = 'Server error. Please try again or contact support.';
              }
            } else if (errorCode === 'RATE_LIMIT_EXCEEDED') {
              displayMessage = 'Too many verification attempts. Please wait a moment and try again.';
            } else if (errorMessage && errorMessage.toLowerCase().includes('rate limit')) {
              displayMessage = 'Too many verification attempts. Please wait a moment and try again.';
            } else if (errorMessage && errorMessage.toLowerCase().includes('database')) {
              displayMessage = 'Database error. Please try again in a moment.';
            }
            
            showError(displayMessage);
            // Keep currentVerificationId so resend can work
          }
        }
      } catch (error) {
        console.error('OTP verification error:', error);
        const errorMessage = error instanceof Error ? error.message : String(error);
        
        // Network errors should allow resend
        if (errorMessage.includes('Network') || errorMessage.includes('fetch')) {
          showError('Network error. Please check your connection and try again, or resend the code.');
        } else {
          showError('Verification failed. Please try again or resend the code.');
        }
        // Don't clear currentVerificationId on error - allow resend
      } finally {
        hideAllMessages(); // Hide loading state
      }
    });

    resendCodeBtn?.addEventListener('click', async () => {
      if (!currentPhoneNumber) {
        showError('No phone number available for resend');
        return;
      }

      // Ensure we have a phone number from the stored value or form
      const phoneToResend = currentPhoneNumber || 
        (document.getElementById('unified-phone-input') as HTMLInputElement)?.value?.trim() ||
        (document.getElementById('phone-input') as HTMLInputElement)?.value?.trim();
      
      if (!phoneToResend) {
        showError('No phone number available for resend');
        return;
      }

      showLoading();

      try {
        // Use main TETRIX 2FA API for resend
        try {
          const response = await fetch('/api/v2/2fa/initiate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              phoneNumber: phoneToResend, // Use the resolved phone number
              method: 'sms',
              userAgent: navigator.userAgent,
              ipAddress: '127.0.0.1', // Will be replaced by server
              sessionId: 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now()
            })
          });

          const result = await response.json();
          
          // Check HTTP status code
          if (!response.ok) {
            const errorMessage = result?.error?.message || result?.error || result?.message || `Server error: ${response.status}`;
            showError(typeof errorMessage === 'string' ? errorMessage : JSON.stringify(errorMessage));
            return;
          }
          
          // API response structure: { success: true, verificationId: "...", message: "..." }
          // verificationId is at top level, not in result.data
          if (result.success && (result.verificationId || result.data?.verificationId)) {
            // Use verificationId from top level (API response structure)
            currentVerificationId = result.verificationId || result.data?.verificationId;
            console.log('‚úÖ Resend successful, new verificationId:', currentVerificationId);
            
            // Update phone number display if needed
            if (phoneToResend !== currentPhoneNumber) {
              currentPhoneNumber = phoneToResend;
            }
            
            startResendTimer();
            showSuccess('New code sent successfully!');
            
            // Clear any previous OTP input errors
            hideAllMessages();
            setTimeout(() => {
              const otpInput = document.getElementById('unified-verification-code') as HTMLInputElement;
              if (otpInput) {
                otpInput.value = '';
                otpInput.focus();
              }
            }, 500);
          } else {
            // Handle error response structure
            const errorMessage = result?.error?.message || result?.error || result?.message || 'Failed to resend code';
            console.error('Resend failed:', { result, errorMessage });
            showError(typeof errorMessage === 'string' ? errorMessage : JSON.stringify(errorMessage));
          }
        } catch (error) {
          console.error('Resend API error:', error);
          showError('Failed to resend code. Please try again.');
        }
      } catch (error) {
        console.error('Resend code error:', error);
        showError('Failed to resend code. Please try again.');
      } finally {
        hideLoading();
      }
    });

    // Step 3: Send Verification Code handlers
    // These buttons are in step 3 div (Send Verification Code)
    // Attach handlers for Step 3 verification method buttons
    // Use event delegation to ensure handlers work even if buttons are dynamically added/removed
    let step3HandlerAttached = false;
    const attachStep3Handlers = () => {
      const step3Div = document.getElementById('auth-step-3');
      if (!step3Div) {
        console.warn('‚ö†Ô∏è Step 3 container not found');
        return;
      }
      
      // Only attach once to prevent duplicate listeners
      if (step3HandlerAttached) {
        return;
      }
      
      // Use event delegation on step3 container to handle clicks
      step3Div.addEventListener('click', (ev) => {
        const target = ev.target as HTMLElement;
        const button = target.closest('#send-sms-btn, #send-call-btn, #send-whatsapp-btn, #send-flashcall-btn') as HTMLButtonElement;
        
        if (!button) return;
        
        ev.preventDefault();
        ev.stopPropagation();
        
        const buttonId = button.id;
        console.log('üîò Step 3 button clicked:', buttonId);
        
        // Map button IDs to verification methods
        const methodMap: Record<string, string> = {
          'send-sms-btn': 'sms',
          'send-call-btn': 'voice',
          'send-whatsapp-btn': 'whatsapp',
          'send-flashcall-btn': 'flashcall'
        };
        
        const method = methodMap[buttonId];
        if (method) {
          console.log(`üöÄ Calling sendVerificationCode('${method}')`);
          sendVerificationCode(method).catch(error => {
            console.error('Error sending verification code:', error);
            showError('Failed to send verification code. Please try again.');
          });
        }
      }, { capture: true });
      
      step3HandlerAttached = true;
      console.log('‚úÖ Step 3 handlers attached via event delegation');
    };
    
    // Attach handlers immediately and also when step 3 is shown
    attachStep3Handlers();
    
    // Wrap showStep to update phone number display when step 3 is shown
    const originalShowStep = showStep;
    const wrappedShowStep = (step: number) => {
      originalShowStep(step);
      if (step === 3) {
        // Small delay to ensure DOM is ready, then update phone number display
        setTimeout(() => {
          const displayPhone = document.getElementById('display-phone-number');
          if (displayPhone && currentPhoneNumber) {
            displayPhone.textContent = currentPhoneNumber;
          }
        }, 50);
      }
    };
    
    // Replace both local and window references
    showStep = wrappedShowStep;
    (window as any).showStep = wrappedShowStep;

    // CRITICAL: Always get fresh reference to prevent "not defined" errors
    const changePhoneBtnElement = getChangePhoneBtn() || (window as any).changePhoneBtn || document.getElementById('change-phone');
    if (changePhoneBtnElement) {
      changePhoneBtnElement.addEventListener('click', () => {
        const stepFunc = (window as any).showStep || showStep;
        if (typeof stepFunc === 'function') {
          stepFunc(1); // Go back to phone entry
        }
      });
    }
    
    backToPhoneVerificationBtn?.addEventListener('click', () => {
      showStep(3); // Go back to "Send Code" step
    });
    
    changePhoneNumberBtn?.addEventListener('click', () => {
      showStep(1); // Go back to phone entry
    });

    // Note: Event delegation for back buttons is now handled in the consolidated modal click handler above
    // This avoids duplicate handlers and ensures proper event flow

    // Keyboard support: Enter on organization triggers continue when valid
    organizationInput?.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        (continueToOtpBtn as HTMLButtonElement)?.click();
      }
    });

    // Initialize modal - reset to step 1
    currentStep = 1;
    showStep(1);
    hideAllMessages();
    
    // CRITICAL: Expose hideAllMessages here after it's been defined
    (window as any).hideAllMessages = hideAllMessages;
    
    (window as any).loadCountries();
  }

  // Intelligent user lookup for returning users
  (window as any).lookupExistingUser = async function(phoneNumber: string) {
    try {
      // Check if user exists in localStorage first
      const existingAuth = localStorage.getItem('tetrixAuth');
      if (existingAuth) {
        const authData = JSON.parse(existingAuth);
        if (authData.phoneNumber === phoneNumber) {
          console.log('‚úÖ Found existing user in localStorage:', authData);
          return {
            success: true,
            user: {
              industry: authData.industry,
              role: authData.role,
              organization: authData.organization,
              phoneNumber: authData.phoneNumber,
              userId: authData.userId
            }
          };
        }
      }
      
      // If not found locally, could check backend database
      // This would integrate with the TetrixAuthService
      console.log('üîç No existing user found for phone:', phoneNumber);
      return { success: false, message: 'New user - proceed with registration' };
    } catch (error) {
      console.error('User lookup error:', error);
      return { success: false, error: 'Lookup failed' };
    }
  };

  // Load countries for phone validation
  (window as any).loadCountries = async function() {
    try {
      // Use existing TetrixAuthService if available, otherwise use fallback
      if ((window as any).TetrixAuthService && (window as any).TetrixAuthService.getSupportedCountries) {
        const result = await (window as any).TetrixAuthService.getSupportedCountries();
        if (result.success && result.countries) {
          (window as any).populateCountrySelect(result.countries);
          return;
        }
      }
      
      // Fallback: Common countries
      const fallbackCountries = [
        { code: '+1', name: 'United States', flag: 'üá∫üá∏' },
        { code: '+44', name: 'United Kingdom', flag: 'üá¨üáß' },
        { code: '+33', name: 'France', flag: 'üá´üá∑' },
        { code: '+49', name: 'Germany', flag: 'üá©üá™' },
        { code: '+81', name: 'Japan', flag: 'üáØüáµ' },
        { code: '+86', name: 'China', flag: 'üá®üá≥' },
        { code: '+91', name: 'India', flag: 'üáÆüá≥' },
        { code: '+61', name: 'Australia', flag: 'üá¶üá∫' },
        { code: '+55', name: 'Brazil', flag: 'üáßüá∑' },
        { code: '+52', name: 'Mexico', flag: 'üá≤üáΩ' }
      ];
      
      (window as any).populateCountrySelect(fallbackCountries);
    } catch (error) {
      console.error('Failed to load countries:', error);
      // Use fallback
      const fallbackCountries = [
        { code: '+1', name: 'United States', flag: 'üá∫üá∏' },
        { code: '+44', name: 'United Kingdom', flag: 'üá¨üáß' },
        { code: '+33', name: 'France', flag: 'üá´üá∑' }
      ];
      (window as any).populateCountrySelect(fallbackCountries);
    }
  };

  // Populate country select dropdown
  (window as any).populateCountrySelect = function(countries: any[]) {
    const countryCodeSelect = document.getElementById('country-code') as HTMLSelectElement;
    if (countryCodeSelect) {
      countryCodeSelect.innerHTML = '<option value="">Select Your Country</option>';
      countries.forEach((country: any) => {
        const option = document.createElement('option');
        option.value = country.code || country.callingCode || '';
        // Make country names fully readable with proper spacing
        const countryName = country.name || country.countryName || '';
        const countryCode = country.code || country.callingCode || '';
        // Store both code and name for better display
        option.textContent = `${countryName} (${countryCode})`;
        countryCodeSelect.appendChild(option);
      });
      console.log(`‚úÖ Loaded ${countries.length} countries into dropdown`);
    } else {
      console.error('‚ùå Country code select element not found');
    }
  };

  // Reset modal to initial state
  (window as any).resetModal = function() {
    const modalTitle = document.getElementById('auth-modal-title');
    const modalSubtitle = document.getElementById('auth-modal-subtitle');
    const phoneForm = document.getElementById('unified-phone-form') as HTMLFormElement;
    const otpForm = document.getElementById('otp-form') as HTMLFormElement;
    const roleSelect = document.getElementById('role-select') as HTMLSelectElement;
    const roleStatus = document.getElementById('role-status');
    const resendTimerInterval = (window as any).resendTimerInterval;
    
    (window as any).currentStep = 1;
    
    // CRITICAL: Always use fallback - manually show step 1 (never rely on showStep which may not be ready)
    const step1 = document.getElementById('auth-step-1');
    const step2 = document.getElementById('auth-step-2');
    const step3 = document.getElementById('auth-step-3');
    const step4 = document.getElementById('auth-step-4');
    [step2, step3, step4].forEach(s => s?.classList.add('hidden'));
    step1?.classList.remove('hidden');
    
    // DON'T call showStep here - it may not be ready. Manual DOM manipulation above is sufficient
    
    // Hide messages if function exists
    if (typeof (window as any).hideAllMessages === 'function') {
    (window as any).hideAllMessages();
    } else {
      // Manual fallback
      const errorDiv = document.getElementById('auth-error');
      const successDiv = document.getElementById('auth-success');
      const loadingDiv = document.getElementById('auth-loading');
      errorDiv?.classList.add('hidden');
      successDiv?.classList.add('hidden');
      loadingDiv?.classList.add('hidden');
    }
    
    // Reset forms
    phoneForm?.reset();
    otpForm?.reset();
    
    // Reset role select
    if (roleSelect) {
      roleSelect.innerHTML = '<option value="">Choose your role...</option>';
      roleSelect.disabled = true;
      roleSelect.classList.add('opacity-50');
    }
    
    if (roleStatus) {
      roleStatus.textContent = '(Select an industry first)';
    }
    
    // Clear verification data
    (window as any).currentVerificationId = null;
    (window as any).currentPhoneNumber = null;
    (window as any).currentCountryCode = null;
    
    // Clear timers
    if (resendTimerInterval) {
      clearInterval(resendTimerInterval);
      (window as any).resendTimerInterval = null;
    }
    
    // Update titles
    if (modalTitle) modalTitle.textContent = 'TETRIX Authentication';
    if (modalSubtitle) modalSubtitle.textContent = 'Secure phone verification required';
  };

  // Global function to open Unified Auth modal - EXPOSE IMMEDIATELY
  // CRITICAL: This must be available BEFORE the script fully executes
  if (typeof window !== 'undefined') {
  (window as any).openUnifiedAuthModal = function() {
      console.log('üîß openUnifiedAuthModal called');
    const modal = document.getElementById('unified-auth-modal');
    if (modal) {
        console.log('‚úÖ Found unified-auth-modal, opening...');
      modal.classList.remove('hidden');
      modal.style.display = 'block';
        modal.style.zIndex = '9999';
        document.body.style.overflow = 'hidden';
      // Call functions that are now in global scope
        if (typeof (window as any).resetModal === 'function') {
          (window as any).resetModal();
        }
        if (typeof (window as any).loadCountries === 'function') {
          (window as any).loadCountries();
        } else {
          // Load countries if not already loaded
          setTimeout(() => {
            if (typeof (window as any).loadCountries === 'function') {
              (window as any).loadCountries();
            }
          }, 100);
        }
        console.log('‚úÖ Modal opened successfully');
        return true;
      } else {
        console.error('‚ùå Unified auth modal element not found');
        // Retry after a short delay - modal might not be in DOM yet
        setTimeout(() => {
          const retryModal = document.getElementById('unified-auth-modal');
          if (retryModal) {
            retryModal.classList.remove('hidden');
            retryModal.style.display = 'block';
            retryModal.style.zIndex = '9999';
            document.body.style.overflow = 'hidden';
            console.log('‚úÖ Modal opened on retry');
          } else {
            alert('Authentication modal not found. Please refresh the page.');
          }
        }, 500);
        return false;
      }
    };
    
    // Expose function immediately - don't wait for DOMContentLoaded
    console.log('üîß window.openUnifiedAuthModal exposed:', typeof (window as any).openUnifiedAuthModal);
    
    // Also expose as a property that's easier to check
    (window as any).__unifiedAuthModalReady = true;
  }

  // Debug: Log available functions
  console.log('üîß Available auth functions:', Object.keys(window).filter(k => k.includes('Unified') || k.includes('Auth') || k.includes('open')));

  // Initialize when DOM is loaded
  if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initUnifiedAuthModal);
  } else {
  // DOM already loaded, initialize immediately
  initUnifiedAuthModal();
}

// CRITICAL FIX: Ensure phone input is visible when modal opens
// This runs after modal becomes visible, applying fix at the right time
(function() {
  // Watch for modal opening
  const modal = document.getElementById('unified-auth-modal');
  if (modal) {
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          const isVisible = !modal.classList.contains('hidden');
          if (isVisible) {
            // Modal just became visible - apply fix immediately
            setTimeout(function() {
              const input = document.getElementById('unified-auth-phone-number');
              const countrySelect = document.getElementById('country-code');
              
              if (input) {
                console.log('üîß Modal opened - applying immediate phone input fix...');
                
                // Apply ALL visibility methods again
                (input as HTMLInputElement).style.color = '#111827';
                (input as HTMLInputElement).style.backgroundColor = '#ffffff';
                (input as HTMLInputElement).style.opacity = '1';
                (input as HTMLInputElement).style.visibility = 'visible';
                (input as HTMLInputElement).style.setProperty('color', '#111827', 'important');
                (input as HTMLInputElement).style.setProperty('-webkit-text-fill-color', '#111827', 'important');
                (input as HTMLInputElement).style.setProperty('caret-color', '#111827', 'important');
                
                console.log('‚úÖ Immediate fix applied to visible input');
              }
              
              // CRITICAL: Ensure country select is populated
              if (countrySelect) {
                const optionCount = (countrySelect as HTMLSelectElement).options?.length || 0;
                console.log('üîç Country select has', optionCount, 'options');
                
                if (optionCount <= 1) {
                  console.warn('‚ö†Ô∏è Country select not populated yet! Loading countries...');
                  // Force load countries
                  if (typeof (window as any).loadCountries === 'function') {
                    (window as any).loadCountries();
                  } else if (typeof loadCountries === 'function') {
                    loadCountries();
                  }
                  
                  // Check again after delay
                  setTimeout(() => {
                    const newOptionCount = (countrySelect as HTMLSelectElement).options?.length || 0;
                    if (newOptionCount > 1) {
                      console.log('‚úÖ Countries loaded successfully, now has', newOptionCount, 'options');
                    } else {
                      console.error('‚ùå Countries still not loaded after delay!');
                    }
                  }, 500);
                }
              }
            }, 50);
          }
        }
      });
    });
    
    observer.observe(modal, {
      attributes: true,
      attributeFilter: ['class']
    });
  }
})();
</script>

<style is:global>
  /* CRITICAL: Ensure phone input is visible */
  #unified-auth-phone-number {
    color: #111827 !important;
    background-color: #ffffff !important;
    opacity: 1 !important;
    visibility: visible !important;
    -webkit-text-fill-color: #111827 !important;
    caret-color: #111827 !important;
  }
  
  #unified-auth-phone-number::placeholder {
    color: #9ca3af !important;
    opacity: 1 !important;
  }
  
  #unified-auth-phone-number:focus {
    color: #111827 !important;
    background-color: #ffffff !important;
    -webkit-text-fill-color: #111827 !important;
  }
  
  #unified-auth-modal {
    z-index: 50;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
  }
  
  #unified-auth-modal:not(.hidden) {
    display: block !important;
  }
  
  /* Form validation styles */
  input:invalid {
    border-color: #ef4444;
  }
  
  input:valid {
    border-color: #10b981;
  }
  
  /* Loading state */
  .animate-spin {
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  /* Button hover effects */
  button:hover {
    transform: translateY(-1px);
  }
  
  button:active {
    transform: translateY(0);
  }
  
  /* Focus styles */
  input:focus, select:focus, button:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
  }
  
  /* OTP input styling */
  #verification-code {
    letter-spacing: 0.5em;
  }

  /* Improved legibility for Industry and Role selects */
  #industry-select,
  #role-select {
    font-size: 1rem; /* 16px */
    line-height: 1.5;
    padding-top: 0.75rem; /* 12px */
    padding-bottom: 0.75rem;
    padding-left: 0.75rem;
    padding-right: 2.25rem; /* leave room for native arrow */
    background-color: #ffffff;
    color: #111827; /* gray-900 */
    border: 1px solid #d1d5db; /* gray-300 */
    border-radius: 0.5rem; /* rounded-lg */
  }

  #industry-select:focus,
  #role-select:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15); /* brand red focus */
    border-color: #ef4444; /* brand red */
  }

  #industry-select option,
  #role-select option {
    font-size: 1rem;
    color: #111827;
    background-color: #ffffff;
    padding: 0.5rem 0.75rem;
  }

  /* Improve placeholder/disabled state visibility */
  #role-select:disabled {
    color: #6b7280; /* gray-500 */
    background-color: #f9fafb; /* gray-50 */
  }

  /* Ensure Organization input remains interactive above overlays */
  #unified-organization-input {
    position: relative;
    z-index: 20;
    pointer-events: auto !important;
    -webkit-user-select: text !important;
    user-select: text !important;
    color: #111827 !important;
    background-color: #ffffff !important;
    -webkit-text-fill-color: #111827 !important;
  }
  
  #unified-organization-input:focus {
    outline: 2px solid #dc2626;
    outline-offset: 2px;
  }
</style>