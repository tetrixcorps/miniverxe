<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TETRIX AuthManager Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #dc2626;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .phone-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #d1d5db;
            border-radius: 5px;
            font-size: 16px;
            margin: 10px 0;
        }
        .phone-input:focus {
            border-color: #ef4444;
            outline: none;
        }
    </style>
</head>
<body>
    <h1>üîê TETRIX AuthManager Test Suite</h1>
    
    <div class="test-section">
        <h2>üì± Phone Number Formatting Test</h2>
        <p>Test international phone number formatting:</p>
        <input type="tel" id="phone-test" class="phone-input" placeholder="Enter phone number (e.g., +1234567890, +447911123456)">
        <div id="format-result" class="test-result info">Enter a phone number to see formatting</div>
        <button class="test-button" onclick="testPhoneFormatting()">Test Formatting</button>
    </div>

    <div class="test-section">
        <h2>üåç International Number Test</h2>
        <p>Test various international phone number formats:</p>
        <button class="test-button" onclick="testInternationalNumbers()">Test International Numbers</button>
        <div id="international-result" class="test-result info">Click button to test international number formatting</div>
    </div>

    <div class="test-section">
        <h2>üîê 2FA API Test</h2>
        <p>Test the 2FA API endpoints:</p>
        <button class="test-button" onclick="test2FAInitiate()">Test 2FA Initiate</button>
        <button class="test-button" onclick="test2FAVerify()">Test 2FA Verify</button>
        <div id="api-result" class="test-result info">Click buttons to test API endpoints</div>
    </div>

    <div class="test-section">
        <h2>üéØ Frontend Integration Test</h2>
        <p>Test the 2FA modal integration:</p>
        <button class="test-button" onclick="open2FAModal()">Open 2FA Modal</button>
        <div id="modal-result" class="test-result info">Click button to test modal functionality</div>
    </div>

    <script>
        // Phone number formatting function (copied from 2FAModal.astro)
        function formatPhoneNumber(input) {
            let value = input.value;
            
            // Allow + at the beginning
            if (value.startsWith('+')) {
                // Keep the + and format the rest
                let digits = value.slice(1).replace(/\D/g, '');
                if (digits.length > 0) {
                    // Handle different country codes and lengths
                    if (digits.length <= 3) {
                        value = `+${digits}`;
                    } else if (digits.length <= 6) {
                        value = `+${digits.slice(0, 1)} (${digits.slice(1, 4)}) ${digits.slice(4)}`;
                    } else if (digits.length <= 10) {
                        value = `+${digits.slice(0, 1)} (${digits.slice(1, 4)}) ${digits.slice(4, 7)}-${digits.slice(7)}`;
                    } else {
                        value = `+${digits.slice(0, 1)} (${digits.slice(1, 4)}) ${digits.slice(4, 7)}-${digits.slice(7, 11)}`;
                    }
                } else {
                    value = '+';
                }
            } else {
                // No + at beginning, add it and format
                let digits = value.replace(/\D/g, '');
                if (digits.length > 0) {
                    // Handle US numbers (10 digits) - add +1
                    if (digits.length === 10) {
                        value = `+1 (${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
                    }
                    // Handle US numbers (11 digits starting with 1)
                    else if (digits.length === 11 && digits.startsWith('1')) {
                        value = `+1 (${digits.slice(1, 4)}) ${digits.slice(4, 7)}-${digits.slice(7)}`;
                    }
                    // Handle other international numbers - more flexible formatting
                    else if (digits.length <= 3) {
                        value = `+${digits}`;
                    } else if (digits.length <= 6) {
                        value = `+${digits.slice(0, 1)} (${digits.slice(1, 4)}) ${digits.slice(4)}`;
                    } else if (digits.length <= 10) {
                        value = `+${digits.slice(0, 1)} (${digits.slice(1, 4)}) ${digits.slice(4, 7)}-${digits.slice(7)}`;
                    } else if (digits.length <= 12) {
                        // Handle longer international numbers
                        value = `+${digits.slice(0, 2)} (${digits.slice(2, 5)}) ${digits.slice(5, 8)}-${digits.slice(8)}`;
                    } else {
                        // Very long numbers - just add + and basic formatting
                        value = `+${digits.slice(0, 2)} (${digits.slice(2, 5)}) ${digits.slice(5, 8)}-${digits.slice(8, 12)}`;
                    }
                } else {
                    value = '';
                }
            }
            
            input.value = value;
        }

        // Test phone number formatting
        function testPhoneFormatting() {
            const input = document.getElementById('phone-test');
            const result = document.getElementById('format-result');
            
            const originalValue = input.value;
            formatPhoneNumber(input);
            const formattedValue = input.value;
            
            result.innerHTML = `
                <strong>Original:</strong> ${originalValue}<br>
                <strong>Formatted:</strong> ${formattedValue}<br>
                <strong>Status:</strong> ${formattedValue !== originalValue ? '‚úÖ Formatted' : '‚ö†Ô∏è No change'}
            `;
            result.className = 'test-result success';
        }

        // Test international numbers
        function testInternationalNumbers() {
            const testNumbers = [
                '1234567890',      // US 10-digit
                '11234567890',     // US 11-digit
                '447911123456',    // UK
                '33142868326',     // France
                '4915123456789',   // Germany
                '81312345678',     // Japan
                '61234567890',     // Australia
                '5511987654321'    // Brazil
            ];
            
            const result = document.getElementById('international-result');
            let html = '<h3>International Number Formatting Results:</h3>';
            
            testNumbers.forEach(number => {
                const input = { value: number };
                formatPhoneNumber(input);
                const formatted = input.value;
                
                html += `
                    <div style="margin: 5px 0; padding: 5px; background: #f9f9f9; border-radius: 3px;">
                        <strong>${number}</strong> ‚Üí <strong>${formatted}</strong>
                    </div>
                `;
            });
            
            result.innerHTML = html;
            result.className = 'test-result success';
        }

        // Test 2FA API
        async function test2FAInitiate() {
            const result = document.getElementById('api-result');
            result.innerHTML = 'Testing 2FA Initiate...';
            result.className = 'test-result info';
            
            try {
                const response = await fetch('/api/v2/2fa/initiate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phoneNumber: '+1234567890',
                        method: 'sms'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    result.innerHTML = `
                        <strong>‚úÖ 2FA Initiate Success!</strong><br>
                        <strong>Verification ID:</strong> ${data.verificationId}<br>
                        <strong>Message:</strong> ${data.message}<br>
                        <strong>Delivery Time:</strong> ${data.estimatedDelivery}
                    `;
                    result.className = 'test-result success';
                    window.testVerificationId = data.verificationId;
                } else {
                    result.innerHTML = `<strong>‚ùå 2FA Initiate Failed:</strong> ${data.error || 'Unknown error'}`;
                    result.className = 'test-result error';
                }
            } catch (error) {
                result.innerHTML = `<strong>‚ùå API Error:</strong> ${error.message}`;
                result.className = 'test-result error';
            }
        }

        async function test2FAVerify() {
            const result = document.getElementById('api-result');
            
            if (!window.testVerificationId) {
                result.innerHTML = '<strong>‚ö†Ô∏è Please run 2FA Initiate test first</strong>';
                result.className = 'test-result error';
                return;
            }
            
            result.innerHTML = 'Testing 2FA Verify...';
            result.className = 'test-result info';
            
            try {
                const response = await fetch('/api/v2/2fa/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        verificationId: window.testVerificationId,
                        code: '123456',
                        phoneNumber: '1234567890'
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.verified) {
                    result.innerHTML = `
                        <strong>‚úÖ 2FA Verify Success!</strong><br>
                        <strong>Verified:</strong> ${data.verified}<br>
                        <strong>Response Code:</strong> ${data.responseCode}<br>
                        <strong>Token:</strong> ${data.token}<br>
                        <strong>Risk Level:</strong> ${data.riskLevel}
                    `;
                    result.className = 'test-result success';
                } else {
                    result.innerHTML = `<strong>‚ùå 2FA Verify Failed:</strong> ${data.error || 'Verification failed'}`;
                    result.className = 'test-result error';
                }
            } catch (error) {
                result.innerHTML = `<strong>‚ùå API Error:</strong> ${error.message}`;
                result.className = 'test-result error';
            }
        }

        // Test modal integration
        function open2FAModal() {
            const result = document.getElementById('modal-result');
            
            // Set auth context
            window.tetrixAuthContext = 'test';
            
            // Try to open the modal
            if (typeof window.open2FAModal === 'function') {
                window.open2FAModal();
                result.innerHTML = '<strong>‚úÖ 2FA Modal opened successfully!</strong><br>Check the modal for proper functionality.';
                result.className = 'test-result success';
            } else {
                result.innerHTML = '<strong>‚ùå 2FA Modal function not found</strong><br>Make sure you are on the main TETRIX page.';
                result.className = 'test-result error';
            }
        }

        // Add event listener for phone input
        document.getElementById('phone-test').addEventListener('input', function(e) {
            formatPhoneNumber(e.target);
        });
    </script>
</body>
</html>
