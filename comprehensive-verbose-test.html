<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Verbose Authentication Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log-container { max-height: 500px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f8f9fa; }
        .log-entry { margin: 2px 0; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 11px; }
        .log-verbose { background-color: #e3f2fd; color: #1565c0; }
        .log-error { background-color: #ffebee; color: #c62828; }
        .log-success { background-color: #e8f5e8; color: #2e7d32; }
        .log-warning { background-color: #fff8e1; color: #f57c00; }
        .log-info { background-color: #f3e5f5; color: #7b1fa2; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .stats { display: flex; gap: 20px; margin: 10px 0; }
        .stat-box { padding: 10px; border: 1px solid #ccc; border-radius: 5px; background: #f8f9fa; }
        iframe { width: 100%; height: 600px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>ðŸ”§ Comprehensive Verbose Authentication Test</h1>
    <p>This test captures all console output including verbose logging from the authentication system.</p>
    
    <div class="stats">
        <div class="stat-box">
            <strong>Total Logs:</strong> <span id="total-logs">0</span>
        </div>
        <div class="stat-box">
            <strong>Verbose Logs:</strong> <span id="verbose-logs">0</span>
        </div>
        <div class="stat-box">
            <strong>Errors:</strong> <span id="error-logs">0</span>
        </div>
        <div class="stat-box">
            <strong>Warnings:</strong> <span id="warning-logs">0</span>
        </div>
    </div>
    
    <div>
        <button onclick="startTest()">Start Comprehensive Test</button>
        <button onclick="testClientLogin()">Test Client Login</button>
        <button onclick="testFunctionAvailability()">Test Functions</button>
        <button onclick="clearLogs()">Clear Logs</button>
        <button onclick="exportLogs()">Export Logs</button>
        <button onclick="analyzeLogs()">Analyze Logs</button>
    </div>
    
    <div>
        <h2>Live Test Environment</h2>
        <iframe id="test-iframe" src="http://localhost:8080/"></iframe>
    </div>
    
    <div>
        <h2>Captured Console Logs</h2>
        <div id="log-container" class="log-container"></div>
    </div>
    
    <div>
        <h2>Analysis Results</h2>
        <div id="analysis-results"></div>
    </div>
    
    <script>
        let allLogs = [];
        let verboseLogs = [];
        let errorLogs = [];
        let warningLogs = [];
        let successLogs = [];
        
        // Override console methods to capture all output
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };
        
        function captureLog(level, args) {
            const message = Array.from(args).map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            const logEntry = {
                level,
                message,
                timestamp: new Date().toISOString(),
                elapsed: Date.now() - window.startTime
            };
            
            allLogs.push(logEntry);
            
            // Categorize logs
            if (level === 'error') {
                errorLogs.push(logEntry);
            } else if (level === 'warn') {
                warningLogs.push(logEntry);
            } else if (message.includes('[VERBOSE]')) {
                verboseLogs.push(logEntry);
            } else if (message.includes('âœ…') || message.includes('success')) {
                successLogs.push(logEntry);
            }
            
            addLogToDisplay(logEntry);
            updateStats();
            
            // Call original console method
            originalConsole[level].apply(console, args);
        }
        
        console.log = (...args) => captureLog('log', args);
        console.error = (...args) => captureLog('error', args);
        console.warn = (...args) => captureLog('warn', args);
        console.info = (...args) => captureLog('info', args);
        
        function addLogToDisplay(logEntry) {
            const container = document.getElementById('log-container');
            const div = document.createElement('div');
            div.className = `log-entry log-${logEntry.level}`;
            div.innerHTML = `<strong>[${logEntry.timestamp}]</strong> [${logEntry.level.toUpperCase()}] ${logEntry.message}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        function updateStats() {
            document.getElementById('total-logs').textContent = allLogs.length;
            document.getElementById('verbose-logs').textContent = verboseLogs.length;
            document.getElementById('error-logs').textContent = errorLogs.length;
            document.getElementById('warning-logs').textContent = warningLogs.length;
        }
        
        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
            document.getElementById('analysis-results').innerHTML = '';
            allLogs = [];
            verboseLogs = [];
            errorLogs = [];
            warningLogs = [];
            successLogs = [];
            updateStats();
        }
        
        function exportLogs() {
            const data = {
                allLogs,
                verboseLogs,
                errorLogs,
                warningLogs,
                successLogs,
                summary: {
                    total: allLogs.length,
                    verbose: verboseLogs.length,
                    errors: errorLogs.length,
                    warnings: warningLogs.length,
                    successes: successLogs.length
                },
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `comprehensive-auth-logs-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function analyzeLogs() {
            const results = document.getElementById('analysis-results');
            results.innerHTML = '';
            
            // Analyze timing issues
            const timingIssues = verboseLogs.filter(log => 
                log.message.includes('waiting') || 
                log.message.includes('attempt') ||
                log.message.includes('not available')
            );
            
            // Analyze function availability
            const functionLogs = verboseLogs.filter(log => 
                log.message.includes('openIndustryAuthModal') ||
                log.message.includes('function found') ||
                log.message.includes('function not available')
            );
            
            // Analyze errors
            const criticalErrors = errorLogs.filter(log => 
                log.message.includes('not available') || 
                log.message.includes('failed') ||
                log.message.includes('blocked')
            );
            
            let analysis = '<h3>Analysis Results</h3>';
            
            analysis += `<p><strong>Timing Issues Found:</strong> ${timingIssues.length}</p>`;
            if (timingIssues.length > 0) {
                analysis += '<ul>';
                timingIssues.forEach(issue => {
                    analysis += `<li>${issue.message}</li>`;
                });
                analysis += '</ul>';
            }
            
            analysis += `<p><strong>Function Availability Issues:</strong> ${functionLogs.length}</p>`;
            if (functionLogs.length > 0) {
                analysis += '<ul>';
                functionLogs.forEach(func => {
                    analysis += `<li>${func.message}</li>`;
                });
                analysis += '</ul>';
            }
            
            analysis += `<p><strong>Critical Errors:</strong> ${criticalErrors.length}</p>`;
            if (criticalErrors.length > 0) {
                analysis += '<ul>';
                criticalErrors.forEach(error => {
                    analysis += `<li>${error.message}</li>`;
                });
                analysis += '</ul>';
            }
            
            results.innerHTML = analysis;
        }
        
        function startTest() {
            console.log('ðŸš€ [TEST] Starting comprehensive authentication test...');
            window.startTime = Date.now();
            
            // Test iframe functionality
            const iframe = document.getElementById('test-iframe');
            iframe.onload = function() {
                console.log('âœ… [TEST] Test iframe loaded successfully');
                setTimeout(() => {
                    testClientLogin();
                }, 2000);
            };
        }
        
        function testClientLogin() {
            console.log('ðŸ” [TEST] Testing Client Login functionality...');
            
            try {
                const iframe = document.getElementById('test-iframe');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const clientLoginBtn = iframeDoc.getElementById('client-login-2fa-btn');
                
                if (clientLoginBtn) {
                    console.log('âœ… [TEST] Client Login button found in iframe');
                    clientLoginBtn.click();
                    console.log('âœ… [TEST] Client Login button clicked');
                } else {
                    console.error('âŒ [TEST] Client Login button not found in iframe');
                }
            } catch (error) {
                console.error('âŒ [TEST] Error accessing iframe:', error);
            }
        }
        
        function testFunctionAvailability() {
            console.log('ðŸ” [TEST] Testing function availability...');
            
            try {
                const iframe = document.getElementById('test-iframe');
                const iframeWindow = iframe.contentWindow;
                
                const functions = [
                    'openIndustryAuthModal',
                    'open2FAModal',
                    'openClientLogin',
                    'tetrixAuthContext'
                ];
                
                functions.forEach(func => {
                    if (typeof iframeWindow[func] === 'function') {
                        console.log(`âœ… [TEST] ${func} is a function`);
                    } else if (iframeWindow[func]) {
                        console.log(`âœ… [TEST] ${func} is available (not a function)`);
                    } else {
                        console.error(`âŒ [TEST] ${func} is NOT available`);
                    }
                });
            } catch (error) {
                console.error('âŒ [TEST] Error testing functions:', error);
            }
        }
        
        // Auto-start test when page loads
        window.addEventListener('load', function() {
            console.log('ðŸš€ [TEST] Page loaded, starting comprehensive test...');
            window.startTime = Date.now();
            setTimeout(() => {
                startTest();
            }, 1000);
        });
    </script>
</body>
</html>
