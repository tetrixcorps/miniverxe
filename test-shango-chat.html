<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHANGO Chat Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">SHANGO AI Chat Test</h1>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Test SHANGO Chat Functionality</h2>
            <p class="text-gray-600 mb-6">Test the SHANGO AI chat system to ensure messages are sent and received correctly.</p>
            
            <div class="space-y-4">
                <button id="test-start-chat" class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-purple-700 hover:to-blue-700 transition-colors">
                    Start SHANGO Chat
                </button>
                
                <div id="chat-container" class="hidden">
                    <div class="border rounded-lg p-4 h-96 bg-gray-50">
                        <div id="messages" class="h-80 overflow-y-auto space-y-2 mb-4">
                            <!-- Messages will appear here -->
                        </div>
                        <div class="flex space-x-2">
                            <input
                                type="text"
                                id="message-input"
                                placeholder="Type your message..."
                                class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            />
                            <button
                                id="send-message"
                                class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-4 py-2 rounded-lg hover:from-purple-700 hover:to-blue-700 transition-colors"
                            >
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Test Results</h2>
            <div id="test-results" class="space-y-2">
                <p class="text-gray-600">Click "Start SHANGO Chat" to begin testing...</p>
            </div>
        </div>
    </div>

    <script>
        let currentSession = null;
        let messages = [];

        function addTestResult(action, message, type) {
            const resultsDiv = document.getElementById('test-results');
            const resultElement = document.createElement('div');
            resultElement.className = `p-3 rounded-lg ${
                type === 'success' ? 'bg-green-100 text-green-800' :
                type === 'error' ? 'bg-red-100 text-red-800' :
                type === 'info' ? 'bg-blue-100 text-blue-800' :
                'bg-gray-100 text-gray-800'
            }`;
            resultElement.innerHTML = `<strong>${action}:</strong> ${message}`;
            resultsDiv.appendChild(resultElement);
        }

        function addMessage(role, content, timestamp = new Date().toISOString()) {
            const message = {
                id: `msg-${Date.now()}`,
                role: role,
                content: content,
                timestamp: timestamp,
                type: 'text'
            };
            
            messages.push(message);
            renderMessages();
        }

        function renderMessages() {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = messages.map(message => `
                <div class="flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-xs px-3 py-2 rounded-lg ${
                        message.role === 'user' 
                            ? 'bg-blue-600 text-white' 
                            : 'bg-gradient-to-r from-purple-100 to-blue-100 text-purple-800 border border-purple-200'
                    }">
                        ${message.role === 'assistant' ? '<div class="flex items-center space-x-1 mb-1"><span class="text-xs font-semibold">âš¡ SHANGO</span></div>' : ''}
                        <p class="text-sm">${message.content}</p>
                        <p class="text-xs opacity-70 mt-1">${new Date(message.timestamp).toLocaleTimeString()}</p>
                    </div>
                </div>
            `).join('');
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function startChat() {
            addTestResult('Chat Start', 'Starting SHANGO chat session...', 'info');
            
            try {
                const response = await fetch('/api/v1/shango/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: `test-user-${Date.now()}`,
                        agentId: 'shango-general',
                        channel: 'chat'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentSession = data.session;
                    messages = data.session.messages || [];
                    
                    addTestResult('Session Created', `Session ID: ${currentSession.id}`, 'success');
                    addTestResult('Messages Loaded', `Loaded ${messages.length} messages`, 'success');
                    
                    document.getElementById('chat-container').classList.remove('hidden');
                    renderMessages();
                } else {
                    throw new Error('Failed to create session');
                }
            } catch (error) {
                addTestResult('Session Error', error.message, 'error');
            }
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message || !currentSession) return;

            addTestResult('Message Send', `Sending: "${message}"`, 'info');
            
            // Add user message immediately
            addMessage('user', message);
            input.value = '';

            try {
                const response = await fetch(`/api/v1/shango/sessions/${currentSession.id}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        role: 'user',
                        agentId: 'shango-general'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    addTestResult('Message Sent', 'Message sent successfully', 'success');
                    addTestResult('AI Response', `Received: "${data.aiResponse.content}"`, 'success');
                    
                    // Add AI response
                    addMessage('assistant', data.aiResponse.content, data.aiResponse.timestamp);
                } else {
                    throw new Error('Failed to send message');
                }
            } catch (error) {
                addTestResult('Send Error', error.message, 'error');
                addMessage('assistant', 'Sorry, I encountered an error. Please try again.');
            }
        }

        // Event listeners
        document.getElementById('test-start-chat').addEventListener('click', startChat);
        document.getElementById('send-message').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
