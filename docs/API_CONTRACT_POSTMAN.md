# TETRIX API Contract (Postman Collection Ready)

This document inventories every implemented HTTP endpoint across the TETRIX platform so you can import them into Postman (or any other client) and begin testing immediately.

- **Frontend (Astro) Base URL**: `http://localhost:8082`
- **Backend (Express) Base URL**: `http://localhost:3001`
- **Authentication**: Unless otherwise stated, all endpoints accept/return JSON and do **not** require authentication headers. Backend Better Auth endpoints expect the session cookies generated by the `/api/v2/2fa/*` flow and issue JWTs for protected resources.

## 1. Health & Diagnostics

| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/health` | Returns platform health metadata (`status`, uptime, memory stats).
| GET | `/api/health/check` | Aggregated checks (database, Stripe, Telnyx, Sinch, Mailgun, OpenAI).
| GET | `/api/performance/metrics` | Frontend performance dashboard feed.
| GET | `/health` (backend) | Simple JSON `{ status: 'OK' }` for infrastructure monitors.

## 2. Contacts & CRM

| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/contacts` | Filterable contact directory (supports `industry`, `search`, `tags`, `limit`, `offset`). |
| POST | `/api/contacts` | Creates a contact (requires `firstName`, `lastName`, `phoneNumber`, optional metadata). |
| POST | `/api/contacts/validate-phone` | Validates a phone number and returns formatting + line-type hints. |
| POST | `/api/contact` | Primary "Contact Us" form endpoint. |
| POST | `/api/contact/notify` | Internal helper to fan-out contact form notifications. |
| POST | `/api/notify-email` | Sends an email notification (Mailgun integration). |

### Example – Create Contact
```http
POST /api/contacts
Content-Type: application/json

{
  "firstName": "Ava",
  "lastName": "Martinez",
  "phoneNumber": "+1-555-123-4567",
  "email": "ava@clinic.io",
  "industry": "healthcare",
  "tags": ["VIP", "SMS Opt-in"],
  "customFields": {
    "ehr": "Epic"
  }
}
```

## 3. Authentication & 2FA

### Frontend (Astro) flows

| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/v2/2fa/initiate` | Starts the multi-channel 2FA flow. Body: `{ phoneNumber, method?, customCode?, timeoutSecs?, userAgent?, ipAddress?, sessionId? }`. |
| POST | `/api/v2/2fa/verify` | Verifies the OTP `{ verificationId, code, phoneNumber?, userAgent?, ipAddress?, sessionId? }`. |
| GET | `/api/v2/2fa/status` | Lookup current verification state (`verificationId`, `phoneNumber`). |
| GET | `/api/v2/2fa/audit` | Returns the recent audit log for 2FA sessions. |
| POST | `/api/v2/industry-auth/initiate` | Industry-specific auth bootstrap (same payload as `/api/v2/2fa/initiate` plus `industry`, `role`, `organization`). |
| POST | `/api/v2/industry-auth/verify` | Verifies industry OTP and stores routing context. |
| GET | `/api/v2/auth/lookup` | Checks if a user exists (`email` or `phone` query params).

### Backend (Express) verification APIs

| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/enterprise-2fa/initiate` | Server-side Telnyx verify orchestration (SMS/Voice/WhatsApp/Flash Call). |
| POST | `/api/enterprise-2fa/verify` | Confirms OTPs issued by the enterprise service. |
| GET | `/api/enterprise-2fa/status` | Lightweight status probe for a verification ID. |
| POST | `/api/v2/2fa/initiate` | Same as frontend but routed to Express (used by Better Auth). |
| POST | `/api/v2/2fa/verify` | Express verification shim. |
| GET | `/api/v2/auth/lookup` | Server-side lookup; mirrors Astro handler but returns Prisma results. |
| `ALL` | `/api/auth/*` | Delegated to Better Auth (`auth.ts`) for fully-managed phone auth + sessions.

### Example – Initiate Enterprise 2FA
```http
POST http://localhost:3001/api/enterprise-2fa/initiate
Content-Type: application/json

{
  "phoneNumber": "+15551234567",
  "method": "sms",
  "timeoutSecs": 300,
  "sessionId": "lead-abc-123"
}
```

### Example – Verify 2FA Code
```http
POST /api/v2/2fa/verify
Content-Type: application/json

{
  "verificationId": "ver_01HG...",
  "code": "123456",
  "phoneNumber": "+15551234567"
}
```

## 4. Dashboard & Commerce APIs

| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/dashboard/products/:industry` | Returns catalog (subscription, eSIM, add-on, services) for `healthcare`, `construction`, `logistics`. |
| POST | `/api/dashboard/cart` | Creates a cart (auto-populates required products). |
| GET | `/api/dashboard/cart?cartId=xyz` | Retrieves cart contents. |
| POST | `/api/dashboard/cart/add` | Adds product to cart `{ cartId, productId, quantity }`. |
| POST | `/api/dashboard/cart/remove` | Removes product from cart `{ cartId, productId }`. |
| POST | `/api/dashboard/checkout` | Validates cart and launches Stripe checkout (or trial flow). |
| GET | `/api/performance/metrics` | UI metrics for dashboards. |
| GET | `/api/v1/dashboard/metrics` | Legacy metrics feed. |

### Example – Add Product to Cart
```http
POST /api/dashboard/cart/add
Content-Type: application/json

{
  "cartId": "cart_123",
  "productId": "esim-fleet-basic",
  "quantity": 1
}
```

## 5. Voice & Telephony

| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/voice/initiate` | Kicks off a Telnyx/Sinch voice session. |
| GET | `/api/voice/initiate-get` | Browser-friendly initiation helper. |
| POST | `/api/voice/initiate-final` | Finalizes voice session routing. |
| POST | `/api/voice/transcribe` | Generic transcription endpoint. |
| POST | `/api/voice/transcribe/health` | Healthcare-specific transcription variant. |
| POST | `/api/voice/texml` / `/texml-enhanced` | Returns dynamic TeXML scripts for IVRs. |
| GET  | `/api/voice/sessions` | Lists active sessions. |
| GET  | `/api/voice/sessions/:sessionId` | Session detail. |
| POST | `/api/voice/webhook` | Telnyx/Sinch webhook receiver. |
| POST | `/api/voice/cleanup` | Garbage collects stale sessions. |
| GET  | `/api/voice/integration/status` | High-level integration diagnostics. |

## 6. Messaging Platforms (JoRoMi & SHANGO)

| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/v1/joromi/sessions` | Creates a JoRoMi AI session. |
| GET  | `/api/v1/joromi/sessions` | Lists sessions. |
| GET  | `/api/v1/joromi/sessions/:sessionId/messages` | Retrieves chat history. |
| POST | `/api/v1/joromi/sessions/:sessionId/messages` | Sends a chat message. |
| GET  | `/api/v1/joromi/sessions/:sessionId/stream` | SSE stream for JoRoMi output. |
| GET  | `/api/v1/joromi/sessions/:sessionId/messages/stream` | SSE per-message stream. |
| POST | `/api/v1/shango/sessions` | Starts SHANGO AI support session. |
| GET  | `/api/v1/shango/sessions` | Lists SHANGO sessions. |
| GET/POST | `/api/v1/shango/sessions/:sessionId/messages` | SHANGO chat interface. |

## 7. Webhooks & Support Utilities

| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/webhooks/telnyx/verify` | Telnyx webhook verification echo. |
| POST | `/api/errors/report` | Client error reporting hook. |
| POST | `/api/debug-request` | Dumps request metadata for troubleshooting. |
| GET  | `/api/.well-known/jwks.json` | JWKS set for frontend. |
| GET  | `/api/jwks` | Alias JWKS endpoint. |

## 8. Backend Express Mount Points

The Express server exposes the following router mounts (see `backend/src/server-with-db.ts`):

| Mount Path | Module |
|------------|--------|
| `/api/enterprise-2fa/*` | `routes/enterprise2FA.ts` |
| `/api/v2/2fa/*` | `routes/unifiedAuth.ts` |
| `/api/v2/auth/*` | `routes/authLookup.ts` |
| `/api/voice/*` | (stub – reserved for future server-side voice ops) |
| `/api/voice/monitoring/*` | Monitoring stubs |
| `/api/auth/*` | Better Auth handler via `auth.ts`

> **Note**: Several Express routers (`tetrixAuth`, `tetrixAuthSessions`, `dashboard`, `voice`, `voiceMonitoring`) are currently stubs and do not expose active routes. They are included for completeness.

## 9. Postman Collection Skeleton

You can recreate this contract in Postman by creating folders matching the sections above and configuring the following collection-level variables:

| Variable | Example | Notes |
|----------|---------|-------|
| `baseUrlFrontend` | `http://localhost:8082` | Astro server |
| `baseUrlBackend` | `http://localhost:3001` | Express server |
| `telnyxWebhookUrl` | `https://your-ngrok-domain/webhooks/telnyx` | Optional |
| `jwtToken` | `<BetterAuth access token>` | For protected backend endpoints |

Each request entry should include the method, full path (e.g. `{{baseUrlFrontend}}/api/v2/2fa/initiate`), sample body, and success/error examples shown above.

---

### References
- `src/pages/api/**/*` – Astro serverless endpoints
- `backend/src/server-with-db.ts` – Express API definitions
- `backend/src/routes/*` – Router implementations
- `docs/EXPLORIUM-LEAD-GENERATION-GUIDE.md` – Related service offerings

This contract now mirrors the current codebase and can be used as the authoritative source when importing into Postman or any other API client.
